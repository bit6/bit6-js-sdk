/*! bit6 - 2.0.0-beta.3 - 2017-06-08T22:30:58.699Z */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.bit6=e():t.bit6=e()}(this,function(){return function(t){function e(r){if(n[r])return n[r].exports;var i=n[r]={i:r,l:!1,exports:{}};return t[r].call(i.exports,i,i.exports,e),i.l=!0,i.exports}var n={};return e.m=t,e.c=n,e.i=function(t){return t},e.d=function(t,n,r){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:r})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=15)}([function(t,e){var n,r=[].slice;n=function(){function t(){this._events={}}return t.prototype.emit=function(){var t,e,n,i,o,s;if(e=arguments[0],t=2<=arguments.length?r.call(arguments,1):[],!this._events[e])return!1;for(s=this._events[e],n=0,i=s.length;n<i;n++)o=s[n],o.apply(null,t);return!0},t.prototype.addListener=function(t,e){var n;return this.emit("newListener",t,e),(null!=(n=this._events)[t]?n[t]:n[t]=[]).push(e),this},t.prototype.on=t.prototype.addListener,t.prototype.once=function(t,e){var n;return n=function(r){return function(){return r.removeListener(t,n),e.apply(null,arguments)}}(this),this.on(t,n),this},t.prototype.removeListener=function(t,e){var n;return this._events[t]?(this._events[t]=function(){var r,i,o,s;for(o=this._events[t],s=[],r=0,i=o.length;r<i;r++)(n=o[r])!==e&&s.push(n);return s}.call(this),this):this},t.prototype.off=t.prototype.removeListener,t.prototype.removeAllListeners=function(t){return delete this._events[t],this},t}(),t.exports=n},function(t,e){t.exports={MEDIA_KINDS:["audio","video","screen","data"]}},function(t,e,n){var r,i,o,s=function(t,e){function n(){this.constructor=t}for(var r in e)a.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},a={}.hasOwnProperty;r=n(0),o=n(4),i=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return s(e,t),e.prototype.init=function(t,e){return this.offeror=t,this.context=e,this.pc=null,this.remoteEls={},this.outgoingTransfer=null,this.incomingTransfer=null},e.prototype.update=function(t,e){var n,r,i;if(this.sendOpts=t,this.recvOpts=e,console.log("Rtc.update send=",this.sendOpts,"recv=",this.recvOpts,"offeror=",this.offeror),this.offeror&&this._preparePeerConnection())return this.sendOpts.data&&this.recvOpts.data&&null==this.dc&&this._createDataChannel(),i={},i.offerToReceiveAudio=null!=(n=this.recvOpts.audio)&&n,i.offerToReceiveVideo=null!=(r=this.recvOpts.video)&&r,this.pc.createOffer(function(t){return function(e){return t._setLocalAndSendOfferAnswer(e)}}(this),function(t){return function(t){return console.log("CreateOffer error",t)}}(),i)},e.prototype.stop=function(){var t,e,n,r,i;n=this.remoteEls;for(e in n)t=n[e],null!=t.src&&(t.src=""),this._removeDomElement(t);return this.remoteEls={},null!=(r=this.dc)&&r.close(),this.dc=null,null!=(i=this.pc)&&i.close(),this.pc=null},e.prototype.getRemoteTrackKinds=function(){var t,e,n,r,i,o,s,a,u,c,l,p;for(e=!1,t=!1,l=null!=(s=null!=(a=this.pc)&&"function"==typeof a.getRemoteStreams?a.getRemoteStreams():void 0)?s:[],n=0,i=l.length;n<i;n++)for(c=l[n],u=c.getTracks(),r=0,o=u.length;r<o;r++)p=u[r],"video"!==p.kind||p.muted||(e=!0),"audio"===p.kind&&(t=!0);return{audio:t,video:e}},e.prototype._preparePeerConnection=function(){var t,e,n,r,i,o;if(null==this.pc&&(this.pc=this._createPeerConnection()),null==this.pc)return!1;for(i={},o=["audio","screen","video"],t=0,n=o.length;t<n;t++)e=o[t],i[e]=this.sendOpts[e];return r=this.context.getLocalStreams(i),"undefined"!=typeof mozRTCPeerConnection&&null!==mozRTCPeerConnection?this._mozSyncLocalStreams(this.pc,r):this._syncLocalStreams(this.pc,r),!0},e.prototype._syncLocalStreams=function(t,e){var n,r,i,o,s,a,u,c,l;for(l={},a=t.getLocalStreams(),n=0,o=a.length;n<o;n++)c=a[n],l[c.id]=c;for(r=0,s=e.length;r<s;r++)c=e[r],l[c.id]?delete l[c.id]:t.addStream(c);u=[];for(i in l)c=l[i],u.push(t.removeStream(c));return u},e.prototype._mozSyncLocalStreams=function(t,e){var n,r,i,o,s,a,u,c,l,p,h,d,f;for(f={},c=t.getSenders(),n=0,s=c.length;n<s;n++)h=c[n],f[h.track.id]=h;for(r=0,a=e.length;r<a;r++)for(h=e[r],l=h.getTracks(),o=0,u=l.length;o<u;o++)d=l[o],f[d.id]?delete f[d.id]:t.addTrack(d,h);p=[];for(i in f)h=f[i],p.push(t.removeTrack(h));return p},e.prototype._createPeerConnection=function(){var t,e,n,r,i,o;try{return t=null!=(o="undefined"!=typeof RTCPeerConnection&&null!==RTCPeerConnection?RTCPeerConnection:mozRTCPeerConnection)?o:webkitRTCPeerConnection,r={iceServers:this.context.getIceServers()},i={optional:[{DtlsSrtpKeyAgreement:!0}]},n=new t(r,i),n.onicecandidate=function(t){return function(e){return t._handleIceCandidate(e.candidate)}}(this),n.ondatachannel=function(t){return function(e){return t._createDataChannel(e.channel)}}(this),n.onaddstream=function(t){return function(e){return t._handleRemoteStreamAdded(e.stream)}}(this),n.onremovestream=function(t){return function(e){return t._handleRemoteStreamRemoved(e.stream)}}(this),n.onaddtrack=function(t){return function(t){return console.log("onaddtrack",t)}}(),n.onremovetrack=function(t){return function(t){return console.log("onremovetrack",t)}}(),n}catch(t){return e=t,console.log("Failed to create PeerConnection, exception: ",e),null}},e.prototype._createDataChannel=function(t){var e;return t||(e={ordered:!0},t=this.pc.createDataChannel("mydc",e)),this.dc=t,t.binaryType="arraybuffer",t.onopen=function(t){return function(){return t._handleDcOpen()}}(this),t.onclose=function(t){return function(){return t._handleDcClose()}}(this),t.onerror=function(t){return function(e){return t._handleDcError(e)}}(this),t.onmessage=function(t){return function(e){return t._handleDcMessage(e)}}(this)},e.prototype._handleDcOpen=function(){return this.emit("dcOpen")},e.prototype._handleDcClose=function(){if(this.outgoingTransfer||this.incomingTransfer)return this._handleDcError("DataChannel closed")},e.prototype._handleDcError=function(t){var e,n,r,i;for(console.log("Data Channel Error:",t),r=[this.outgoingTransfer,this.incomingTransfer],e=0,n=r.length;e<n;e++)i=r[e],i&&(i.err=t),i&&this.emit("transfer",i);return this.outgoingTransfer=this.incomingTransfer=null},e.prototype._handleDcMessage=function(t){var e,n,r;return e=t.data,this.incomingTransfer?null==e.byteLength?console.log("Error: incoming transfer data",e):(n=this.incomingTransfer._gotChunk(e),this.emit("transfer",this.incomingTransfer),n?this.incomingTransfer=null:void 0):null!=e.byteLength?console.log("Error: incoming transfer not created for:",e):(r=JSON.parse(e),r?(this.incomingTransfer=new o(!1,r),this.emit("transfer",this.incomingTransfer)):console.log("Error: could not parse incoming transfer info:",e))},e.prototype._handleIceCandidate=function(t){if(t)return this.emit("icecandidate",t)},e.prototype._handleRemoteStreamAdded=function(t){var n,r,i,o,s,a,u,c;for(t.onaddtrack=function(t){return function(e){return t._handleRemoteTrackAdded(e.target,e.track)}}(this),t.onremovetrack=function(t){return function(e){return t._handleRemoteTrackRemoved(e.target,e.track)}}(this),i=!1,r=!1,a=t.getTracks(),o=0,s=a.length;o<s;o++)c=a[o],"video"!==c.kind||c.muted||(i=!0),"audio"===c.kind&&(r=!0);return n=null,i?(n=document.createElement("video"),this.emit("video",n,1)):r&&(n=document.createElement("audio"),"plugin"===("undefined"!=typeof window&&null!==window?window.webrtcDetectedType:void 0)&&"undefined"!=typeof document&&null!==document&&null!=(u=document.body)&&u.appendChild(n)),n&&(n.setAttribute("autoplay","true"),n=e.attachMediaStream(n,t)),this.remoteEls[t.id]=n},e.prototype._handleRemoteStreamRemoved=function(t){var e;if(t.onaddtrack=null,t.onremovetrack=null,e=this.remoteEls[t.id],delete this.remoteEls[t.id],null!=e)return null!=e.src&&(e.src=""),this._removeDomElement(e)},e.prototype._handleRemoteTrackAdded=function(t,e){if("video"===e.kind)return this._handleRemoteStreamRemoved(t),this._handleRemoteStreamAdded(t)},e.prototype._handleRemoteTrackRemoved=function(t,e){if("video"===e.kind)return this._handleRemoteStreamRemoved(t),this._handleRemoteStreamAdded(t)},e.prototype._removeDomElement=function(t){var e,n,r,i,o,s,a,u;if(i=null!=t&&null!=(s=t.nodeName)&&"function"==typeof s.toLowerCase?s.toLowerCase():void 0,n=!1,"object"===i){if(t.children)for(a=t.children,e=0,r=a.length;e<r;e++)o=a[e],"tag"===o.name&&"audio"===o.value&&(n=!0)}else"audio"===i&&(n=!0);return n?null!=(u=t.parentNode)&&"function"==typeof u.removeChild?u.removeChild(t):void 0:this.emit("video",t,-1)},e.prototype._setLocalAndSendOfferAnswer=function(t){return this.pc.setLocalDescription(t,function(e){return function(){return e.emit("offerAnswer",t)}}(this),function(e){return console.log("Error setting PeerConnection localDescription",e,t)})},e.prototype.gotRemoteOfferAnswer=function(t){var e,n,r,i;switch(e=null!=(r="undefined"!=typeof RTCSessionDescription&&null!==RTCSessionDescription?RTCSessionDescription:mozRTCSessionDescription)?r:webkitRTCSessionDescription,n=new e(t),t.type){case"offer":return this._preparePeerConnection(),this.pc.setRemoteDescription(n,function(){return!0},function(t){return console.log("Error setting PeerConnection remoteDescription for offer",t,n)}),this.pc.createAnswer(function(t){return function(e){return t._setLocalAndSendOfferAnswer(e)}}(this),function(t){return function(t){return console.log("CreateAnswer error",t)}}());case"answer":return null!=(i=this.pc)?i.setRemoteDescription(n,function(){return!0},function(t){return console.log("Error setting PeerConnection remoteDescription for answer",t,n)}):void 0}},e.prototype.gotRemoteIceCandidate=function(t){var e,n;return console.log("Adding remote IceCandidate",t),n=new RTCIceCandidate(t),null!=(e=this.pc)?e.addIceCandidate(n):void 0},e.prototype.startOutgoingTransfer=function(t){var e,n,r,i,o,s;return!this.outgoingTransfer&&(!!this.dc&&("open"===this.dc.readyState&&(this.outgoingTransfer=t,this.dc.send(JSON.stringify(t.info)),n=t.data,r=10,e=16384,o=0,s=n.byteLength,i=0,i=setInterval(function(r){return function(){var a,u,c;if(a=!1,t=r.outgoingTransfer,t&&!t.err||(a=!0),!a){if((null!=(c=r.dc)?c.bufferedAmount:void 0)>50*e)return;u=o+e,u>s&&(u=s),r.dc.send(n.slice(o,u)),o=u,t.progress=o,a=o>=s}if(a&&(r.outgoingTransfer=null,clearInterval(i)),t)return r.emit("transfer",t)}}(this),r))))},e.attachMediaStream=function(t,e){var n,r;if(null!=("undefined"!=typeof window&&null!==window?window.attachMediaStream:void 0))return window.attachMediaStream(t,e);r=!1;try{null!=t?t.srcObject:void 0,r=!0}catch(t){n=t,console.log(n)}return r?t.srcObject=e:null!=(null!=t?t.mozSrcObject:void 0)?t.mozSrcObject=e:null!=(null!=t?t.src:void 0)?t.src=URL.createObjectURL(e):console.log("Error attaching stream to element",t),t},e.stopMediaStream=function(t){var e,n,r,i,o;if(t.stop)return t.stop();if(t.getTracks){for(r=t.getTracks(),i=[],e=0,n=r.length;e<n;e++)o=r[e],i.push(null!=o?o.stop():void 0);return i}},e}(r),t.exports=i},function(t,e,n){"use strict";function r(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");return"="===t[e-2]?2:"="===t[e-1]?1:0}function i(t){return 3*t.length/4-r(t)}function o(t){var e,n,i,o,s,a,u=t.length;s=r(t),a=new p(3*u/4-s),i=s>0?u-4:u;var c=0;for(e=0,n=0;e<i;e+=4,n+=3)o=l[t.charCodeAt(e)]<<18|l[t.charCodeAt(e+1)]<<12|l[t.charCodeAt(e+2)]<<6|l[t.charCodeAt(e+3)],a[c++]=o>>16&255,a[c++]=o>>8&255,a[c++]=255&o;return 2===s?(o=l[t.charCodeAt(e)]<<2|l[t.charCodeAt(e+1)]>>4,a[c++]=255&o):1===s&&(o=l[t.charCodeAt(e)]<<10|l[t.charCodeAt(e+1)]<<4|l[t.charCodeAt(e+2)]>>2,a[c++]=o>>8&255,a[c++]=255&o),a}function s(t){return c[t>>18&63]+c[t>>12&63]+c[t>>6&63]+c[63&t]}function a(t,e,n){for(var r,i=[],o=e;o<n;o+=3)r=(t[o]<<16)+(t[o+1]<<8)+t[o+2],i.push(s(r));return i.join("")}function u(t){for(var e,n=t.length,r=n%3,i="",o=[],s=0,u=n-r;s<u;s+=16383)o.push(a(t,s,s+16383>u?u:s+16383));return 1===r?(e=t[n-1],i+=c[e>>2],i+=c[e<<4&63],i+="=="):2===r&&(e=(t[n-2]<<8)+t[n-1],i+=c[e>>10],i+=c[e>>4&63],i+=c[e<<2&63],i+="="),o.push(i),o.join("")}e.byteLength=i,e.toByteArray=o,e.fromByteArray=u;for(var c=[],l=[],p="undefined"!=typeof Uint8Array?Uint8Array:Array,h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d=0,f=h.length;d<f;++d)c[d]=h[d],l[h.charCodeAt(d)]=d;l["-".charCodeAt(0)]=62,l["_".charCodeAt(0)]=63},function(t,e,n){var r,i;i=n(3),r=function(){function t(t,e,n){var r;this.outgoing=t,this.info=e,this.progress=0,this.total=null!=(r=this.info.size)?r:0,this.err=null,this.data=null!=n?n:null,this.outgoing||(this.buf=[])}return t.prototype.pending=function(){return this.outgoing&&this.data&&!this.err&&0===this.progress},t.prototype.completed=function(){return this.progress===this.total&&this.data&&!this.err},t.prototype.percentage=function(){return this.total?(100*this.progress/this.total).toFixed(2):0},t.prototype.json=function(t){var e,n,r,i,o,s,a;if(t){for(this.info.type="application/json",a=JSON.stringify(t),e=new Uint8Array(a.length),n=r=0,o=a.length;0<=o?r<o:r>o;n=0<=o?++r:--r)e[n]=a.charCodeAt(n);this.info.size=e.byteLength,this.data=e.buffer}else{if(!1===this.info.type)return null;for(e=new Uint8Array(this.data),a="",n=i=0,s=e.length;0<=s?i<s:i>s;n=0<=s?++i:--i)a+=String.fromCharCode(e[n]);t=JSON.parse(a)}return t},t.prototype._ensureSourceData=function(e){return null!=this.data?e(null):t.readFileAsArrayBuffer(this.info,function(t){return function(n,r,i){return null!=n&&(t.err=n),null!=i&&null!=r&&(t.info=r),null!=i&&(t.data=i),e(n)}}(this))},t.prototype._gotChunk=function(t){return this.buf.push(t),this.progress+=t.byteLength,!(this.progress<this.total)&&(this._prepareReceivedData(),!0)},t.prototype._prepareReceivedData=function(){var t,e,n,r,i,o;for(o=new Uint8Array(this.progress),r=0,i=this.buf,e=0,n=i.length;e<n;e++)t=i[e],o.set(new Uint8Array(t),r),r+=t.byteLength;return this.buf=null,this.data=o.buffer},t.readFileAsArrayBuffer=function(t,e){var n;return n=new FileReader,n.onload=function(r){var i,o;if(n.readyState===FileReader.DONE)return i=r.target.result,console.log(t.name+" - read "+i.byteLength+"b"),o={name:t.name,type:t.type,size:t.size},e(null,o,i)},n.onerror=function(t){return e(t)},n.onabort=function(t){return e(t)},n.readAsArrayBuffer(t)},t.dataUrlToBlob=function(t){var e,n,r,o,s;return r=";base64,",s=null,n=null,t.indexOf(r)<0?(o=t.split(","),n=o[0].split(":")[1],s=decodeURIComponent(o[1])):(o=t.split(r),n=o[0].split(":")[1],e=i.toByteArray(o[1]),s=e.buffer),new Blob([s],{type:n})},t}(),t.exports=r},function(t,e,n){var r,i,o,s=function(t,e){function n(){this.constructor=t}for(var r in e)a.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},a={}.hasOwnProperty;o=n(0),i=n(9),r=function(t){function e(t,n){var r;this.signal=t,this.options=n,e.__super__.constructor.apply(this,arguments),null==this.options&&(this.options={}),null==(r=this.options).sync&&(r.sync=!1),this.conversations={},this.signal.on("channel",function(t){return function(t,e){return console.log("Chat onChannel event",e,t.id)}}()),this.signal.conn.addHandler("chat",this._handleRpcNotify.bind(this),null),this._typingTimer=setInterval(function(t){return function(){var e,n,r,i;r=t.conversations,i=[];for(n in r)e=r[n],i.push(e._expireTyping());return i}}(this),1e3),!0!==this.options.sync&&!0!==this.options.sync.conversations||setTimeout(function(t){return function(){return t.fetchConversations()}}(this),50)}var n;return s(e,t),n="/",e.prototype.destroy=function(){var t,e;return clearInterval(this._typingTimer),null!=(t=this.signal)&&null!=(e=t.conn)&&e.removeHandler("chat"),this.signal=null},e.prototype.create=function(t,e){return null==t&&(t={}),this.signal.conn.rpc("chat.conversation.create",t,function(t){return function(n,r){var i;return console.log("chat.conversation.create",n,r),n?"function"==typeof e?e(n):void 0:(null!=r?r.id:void 0)?(i=t._addConversation(r),"function"==typeof e?e(null,i):void 0):"function"==typeof e?e("Cannot create conversation"):void 0}}(this))},e.prototype.join=function(t,e){return this.signal.conn.rpc("chat.conversation.join",{id:t},function(t){return function(n,r){var i;return console.log("chat.conversation.join",n,r),n?"function"==typeof e?e(n):void 0:(null!=r?r.id:void 0)?(i=t._addConversation(r),"function"==typeof e?e(null,i):void 0):"function"==typeof e?e("Cannot join conversation"):void 0}}(this))},e.prototype.leave=function(t,e){var n,r;return(n=this.conversations[t])?(this._removeConversation(n),r={id:t},this.signal.conn.rpc("chat.conversation.leave",r,function(n){return console.log("Left conversation",t),"function"==typeof e?e(n):void 0})):"function"==typeof e?e("No conversation"):void 0},e.prototype.fetchConversations=function(t){return this.signal.conn.rpc("chat.conversation.list",{},function(e){return function(n,r){return console.log("chat.conversation.list",n,r),n||e._applyConversations(r,!0),"function"==typeof t?t(n):void 0}}(this))},e.prototype._applyConversations=function(t,e){var n,r,i,o,s,a,u,c;for(c=null,s=this.conversations,e&&(c=Object.assign({},this.conversations),s={}),r=0,o=t.length;r<o;r++)a=t[r],n=this.conversations[a.id],n?(s[a.id]=n,e&&delete c[a.id]):(n=this._addConversation(a),s[a.id]=n);if(e){this.conversations=s,u=[];for(i in c)n=c[i],u.push(this._removeConversation(n));return u}},e.prototype._addConversation=function(t){var e,r,o,s;return s=t.id,null!=(e=this.conversations[s])?e:(o="_c."+s,r=this.signal.join(o,{presence:!1}),r.on("message",function(t){return function(t){var r,i;return r=null!=(i=t.from)?i.split(n)[0]:void 0,e._handleRemoteSignal(t,r)}}()),e=new i(this,t),this.conversations[s]=e,this.emit("conversation",e,1),!0!==this.options.sync&&!0!==this.options.sync.participants||e.fetchParticipants(),!0!==this.options.sync&&!0!==this.options.sync.messages||e.fetchMessages(),e)},e.prototype._removeConversation=function(t){var e,n;return delete this.conversations[t.id],e="_c."+t.id,null!=(n=this.signal.channels[e])&&n.leave(),this.emit("conversation",t,-1),t},e.prototype._prepareAttachment=function(t,e,n){var r;return r={type:t,thumb:e},this.signal.conn.rpc("chat.attachment.prepare",r,function(t){return function(t,e){return console.log("chat.attachment.prepare",t,e),n(t,e)}}())},e.prototype._applyParticipant=function(t,e,n){var r;return(r=this.conversations[t])?n<0&&r.me.id===e.id?this._removeConversation(r):r._applyParticipant(e,n):n<0?void 0:this.signal.conn.rpc("chat.conversation.get",{id:t},function(t){return function(e,n){if(console.log("chat.conversation.get",e,n),n)return t._applyConversations([n],!1)}}(this))},e.prototype._applyMessage=function(t,e,n){var r;if(r=this.conversations[t])return r._applyMessage(e,n)},e.prototype._handleRpcNotify=function(t,e){var n,r;switch((null!=e&&null!=(r=e.id)?r.startsWith("_c."):void 0)&&(n=e.id.substring(3)),console.log("Chat.handleRpcNotify",t,e),t){case"participant":case"participant.channel":return this._applyParticipant(n,e.data,e.op);case"message.channel":return this._applyMessage(n,e.data,e.op)}},e}(o),t.exports=r},function(t,e,n){var r,i,o,s=function(t,e){function n(){this.constructor=t}for(var r in e)a.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},a={}.hasOwnProperty;o=n(3),i=n(0),r=function(t){function e(t){e.__super__.constructor.apply(this,arguments),this.update(t)}var n;return s(e,t),n="/",e.prototype.destroy=function(){return this.clear()},e.prototype.clear=function(){var t,e,n,r,i;for(this.expTimer&&(clearTimeout(this.expTimer),this.expTimer=null),r=["token","claims","identity","device"],i=[],t=0,e=r.length;t<e;t++)n=r[t],i.push(this[n]=null);return i},e.prototype.update=function(t){var r,i,o,s,a,u,c,l,p;this.clear(),this.token=t,s=this.token.split("."),r=null!=s?s[1]:void 0;try{r=e.base64urlDecode(r),r&&(this.claims=JSON.parse(r)),c=null!=(a=this.claims)&&null!=(u=a.sub)?u.split(n):void 0,this.identity=c[0],this.device=c[1]}catch(t){o=t,console.log("Error parsing AccessToken JWT claims",o,r)}if(this.emit("updated",this),(null!=(l=this.claims)?l.exp:void 0)>0)return i=1e3*(null!=(p=this.claims)?p.exp:void 0)-Date.now()-1e4,i<0&&(i=0),this.expTimer=setTimeout(function(t){return function(){return t.expTimer=null,t.emit("expired",t)}}(this),i)},e.base64urlDecode=function(t){var e;return t?(t+=new Array(4-(t.length+3&3)).join("="),e=o.toByteArray(t),String.fromCharCode.apply(null,e)):null},e}(i),t.exports=r},function(t,e,n){var r,i,o,s,a=function(t,e){function n(){this.constructor=t}for(var r in e)u.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},u={}.hasOwnProperty;i=n(0),s=n(14),r=n(16),o=function(t){function e(t){this.accessToken=t,e.__super__.constructor.apply(this,arguments),this.channels={},this.conn=new s,this._updateWsRpc(),this.accessToken.on("updated",function(t){return function(){return t._updateWsRpc()}}(this)),this.conn.addHandler("signal",this._handleRpcNotify.bind(this),null),this.conn.on("open",function(t){return function(){return t.emit("connect")}}(this)),this.conn.on("close",function(t){return function(){var e,n,r;n=t.channels,t.channels={};for(r in n)e=n[r],t.emit("channel",e,-1);return t.emit("disconnect")}}(this)),setTimeout(function(t){return function(){return t.conn.connect()}}(this),0)}return a(e,t),e.prototype.destroy=function(){var t;return null!=(t=this.conn)?t.disconnect():void 0},e.prototype._updateWsRpc=function(){var t;return t=this.accessToken.claims.aud+"/signal/pubsub",0===t.indexOf("http")&&(t="ws"+t.substring(4)),t+="?jwt="+this.accessToken.token,this.conn.update({url:t})},e.prototype._handleRpcNotify=function(t,e){var n;if(null!=(null!=e?e.id:void 0))return void(null!=(n=this.channels[null!=e?e.id:void 0])&&n._handleRpcNotify(t,e));switch(t){case"send":return this.emit("message",e)}},e.prototype.send=function(t){return null!=(null!=t?t.to:void 0)&&(this.rpc("send",t),!0)},e.prototype.join=function(t,e){var n,i,o,s,a;if(!t)return null;if(null!=(n=this.channels[t]))return n;if(s=this.accessToken.claims.sub,n=new r(this,t,e,s),this.channels[t]=n,i={id:t},e&&null!=e)for(o in e)a=e[o],i[o]=a;return this.rpc("join",i),this.emit("channel",n,1),n},e.prototype._leave=function(t){var e;return null!=(null!=t?t.id:void 0)&&(t=t.id),e=this.channels[t],e&&(delete this.channels[t],this.rpc("leave",{id:t}),this.emit("channel",e,-1)),e},e.prototype.rpc=function(t,e){return this.conn.rpc("signal."+t,e)},e}(i),t.exports=o},function(t,e,n){var r,i,o,s,a=function(t,e){function n(){this.constructor=t}for(var r in e)u.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},u={}.hasOwnProperty;r=n(0),i=n(21),o=n(22),s=function(t){function e(t){this.signal=t,e.__super__.constructor.apply(this,arguments),this.sessions={},this.capture=new i,this.signal.on("channel",function(t){return function(e,n){var i;if(!(!n<0)&&(i=t.sessions[e.id]))return i._destroy(),delete t.sessions[i.id],t.emit("session",i,-1),r(t.sessions)?t.capture.stop():void 0}}(this)),this.signal.conn.addHandler("video",this._handleRpcNotify.bind(this),null),this.iceServers=[{url:"stun:stun.l.google.com:19302"}],this._requestIceServers()}var n,r;return a(e,t),n=3600,r=function(t){var e,n;for(e=0,n=t.length;e<n;e++)return t[e],!1;return!0},e.prototype.destroy=function(){return this.iceTimer&&clearTimeout(this.iceTimer),this.iceTimer=null},e.prototype._requestIceServers=function(){return this.signal.conn.rpc("video.ice.get",{ttl:n},function(t){return function(e,r){var i,o,s;if(console.log("video.ice.get response",e,r),null!=r?r.iceServers:void 0){t.iceServers=r.iceServers,o=t.sessions;for(i in o)s=o[i],s.options.iceServers=t.iceServers;return setTimeout(function(){return t._requestIceServers()},1e3*(n-30))}}}(this))},e.prototype.getIceServers=function(){return this.iceServers},e.prototype.create=function(t,e){return this.signal.conn.rpc("video.session.create",t,function(t){return function(n,r){var i;return console.log("video.session.create",n,r),n?"function"==typeof e?e(n):void 0:(null!=r?r.id:void 0)?(i=t._setup(r.id,r),"function"==typeof e?e(null,i):void 0):"function"==typeof e?e("Cannot create session"):void 0}}(this))},e.prototype.join=function(t,e){return this.signal.conn.rpc("video.session.join",{id:t},function(t){return function(n,r){var i;return console.log("video.session.join",n,r),n?"function"==typeof e?e(n):void 0:(null!=r?r.id:void 0)?(i=t._setup(r.id,r),"function"==typeof e?e(null,i):void 0):"function"==typeof e?e("Cannot join session"):void 0}}(this))},e.prototype._setup=function(t,e){var n,r;return null!=(r=this.sessions[t])?r:(n=this.signal.join(t,{presence:!0}),null==e&&(e={}),r=new o(t,e,n,this.capture,this.getIceServers.bind(this)),this.sessions[t]=r,this.emit("session",r,1),r)},e.prototype._handleRpcNotify=function(t,e){var n,r,i,o;switch(console.log("Video.handleRpcNotify",t,e),t){case"publish":return null!=(n=this.sessions[e.id])&&null!=(r=n.rtc)?r.gotRemoteOfferAnswer(e.data):void 0;case"subscribe":return null!=(i=this.sessions[e.id])&&null!=(o=i.participants[e.from])?o._subscribeFromSfu(e.data):void 0}},e}(r),t.exports=s},function(t,e,n){var r,i,o,s,a,u,c=function(t,e){function n(){this.constructor=t}for(var r in e)l.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},l={}.hasOwnProperty;i=n(0),o=n(10),s=n(11),a=n(12),u=n(13),r=function(t){function e(t,n){var r,i,s;this.chat=t,e.__super__.constructor.apply(this,arguments),this.id=null,this.created=0;for(i in n)s=n[i],this[i]=s;r=this.chat.signal.accessToken.identity,this.me=new o(this,r),this.me.on("seenSet",function(t){return function(){return t._sendUpdateMe()}}(this)),this.me.on("stateSet",function(t){return function(e){return t._sendUpdateMe()}}(this)),this.participants={},this.messages=[],this._startedTyping={},this._online={}}var n,r;return c(e,t),e.prototype._update=function(t){var e,n,r,i,o;for(e=!1,o=["state"],i=0,r=o.length;i<r;i++)n=o[i],this[n]!==t[n]&&(this[n]=t[n],e=!0);return e},e.prototype.updateState=function(t,e){return this.state=t,"function"==typeof e?e(null):void 0},e.prototype.leave=function(t){return this.chat.leave(this.id,t)},e.prototype.send=function(t,e){var n;return console.log("Send message to Conversation",t),n={conversation:this.id},n=Object.assign(n,t),this._rpc("chat.message.send",n,function(t){return function(n,r){var i;return n||(i=t._applyMessage(r,1)),"function"==typeof e?e(n,i):void 0}}(this))},e.prototype.compose=function(){return new a(this)},e.prototype.fetchMessages=function(t,e){return null==t&&(t={}),null==t.limit&&(t.limit=50),t.conversation=this.id,this._rpc("chat.message.list",t,function(t){return function(n,r){return n||t._applyMessages(r),"function"==typeof e?e(n,r):void 0}}(this))},e.prototype.getUnreadCount=function(t){var e,r,i,o,s,a;if(a=null!=(s=t.seen)?s:0,0===(i=this.messages.length))return 0;if(o=this.messages[i-1],a>=o.created)return 0;for(r=n(this.messages,{created:a},function(t,e){var n;return n=t.created-e.created,n>0?1:n<0?-1:0}),r>=0?r++:r=~r,e=0;r<i;)this.messages[r].from!==this.me.id&&e++,r++;return e},e.prototype._applyMessages=function(t){var e,n,r,i,o,a,u,c,l,p,h,d,f,g,m,v;for(e=this.messages,i=function(){var e,n,r;for(r=[],n=0,e=t.length;n<e;n++)d=t[n],r.push(new s(d));return r}(),g=[],a=u=0,n=[],v=[];a<e.length&&u<i.length;)r=e[a],o=i[u],r.id<o.id?(g.push(r),a++):r.id>o.id?(g.push(o),n.push(o),u++):(r._update(o)&&v.push(r),g.push(r),a++,u++);for(;a<e.length;)g.push(e[a]),a++;for(;u<i.length;)g.push(i[u]),n.push(i[u]),u++;for(this.messages=g,h=0,c=n.length;h<c;h++)p=n[h],this.emit("message",p,1);for(m=[],f=0,l=v.length;f<l;f++)p=v[f],m.push(this.emit("message",p,0));return m},e.prototype._applyMessage=function(t,e){var i,o,a;if(i=!1,a=new s(t),e>=0){if(this._stopTyping(a.from),0===this.messages.length||a.id>this.messages[this.messages.length-1].id?(this.messages.push(a),i=!0):a.id<this.messages[0].id&&(this.messages.unshift(a),i=!0),i)return this.emit("message",a,e),a}else if(0===this.messages.length||a.id<this.messages[0].id||a.id>this.messages[this.messages.length-1].id)return null;return o=n(this.messages,a,function(t,e){return t.id.localeCompare(e.id)}),o>=0?(a=this.messages[o],e>=0?a._update(t)&&this.emit("message",a,0):(this.messages.splice(o,1),this.emit("message",a,-1))):(o=~o,r(this.messages,a,o),this.emit("message",a,1)),a},e.prototype.add=function(t,e){var n;return n={id:t,conversation:this.id},this._rpc("chat.participant.add",n,function(t){return function(n,r){var i;return n?"function"==typeof e?e(n):void 0:r.id?(i=t._addParticipant(r),"function"==typeof e?e(null,i):void 0):"function"==typeof e?e("Missing participant id"):void 0}}(this))},e.prototype.kick=function(t,e){var n,r;return n=this.participants[t],console.log("Found to kick",n),n?(this._removeParticipant(n),r={id:t,conversation:this.id},this._rpc("chat.participant.kick",r,function(t){return function(t,n){return"function"==typeof e?e(t):void 0}}())):"function"==typeof e?e("No participant"):void 0},e.prototype.fetchParticipants=function(){var t;return t={conversation:this.id},this._rpc("chat.participant.list",t,function(t){return function(e,n){if(!e)return t._applyParticipants(n,!0)}}(this))},e.prototype._applyParticipants=function(t,e){var n,r,i,o,s,a,u,c;for(c=null,o=this.participants,e&&(c=Object.assign({},this.participants),o={}),i=0,r=t.length;i<r;i++)s=t[i],this.me.id!==s.id?(a=this.participants[s.id],a?(o[s.id]=a,e&&delete c[s.id],a._update(s)&&(this.emit("participant",a,0),a.emit("change"))):(a=this._addParticipant(s),o[s.id]=a)):this.me._update(s)&&this.me.emit("change");if(e){this.participants=o,u=[];for(n in c)a=c[n],u.push(this._removeParticipant(a));return u}},e.prototype._applyParticipant=function(t,e){var n;if(this.me.id===t.id)return void(this.me._update(t)&&this.me.emit("change"));if(n=this.participants[t.id]){if(e<0)return this._removeParticipant(n);if(n._update(t))return this.emit("participant",n,0),n.emit("change")}else if(e>=0)return this._addParticipant(t)},e.prototype._addParticipant=function(t){var e;return e=new u(this,t),this.participants[e.id]=e,this.emit("participant",e,1),e},e.prototype._removeParticipant=function(t){return delete this.participants[t.id],this.emit("participant",t,-1),t},e.prototype._sendUpdateMe=function(t){var e,n;return e=this.me,n={role:e.role,seen:e.seen,seenId:e.seenId,state:e.state,id:"me",conversation:this.id},this._rpc("chat.participant.update",n,function(e,n){return console.log("me.update sent",e,n),"function"==typeof t?t(e):void 0})},e.prototype._handleRemoteSignal=function(t,e){var n,r,i;switch(t.type){case"typing":if(n=null!=(i=t.data)&&i,console.log("Got typing",n,"from",e,"in",this.id),!(r=this.participants[e]))return;if(n){if(this._startedTyping[e]=Date.now(),r.typing)return}else if(delete this._startedTyping[e],!r.typing)return;return r.typing=n,r.emit("typing",r.typing)}},e.prototype._expireTyping=function(){var t,e,n,r,i,o,s;r=Date.now(),s=[],i=this._startedTyping;for(t in i)i[t]+9e3>r||s.push(t);for(o=[],n=0,e=s.length;n<e;n++)t=s[n],o.push(this._stopTyping(t));return o},e.prototype._stopTyping=function(t){var e;if(delete this._startedTyping[t],e=this.participants[t])return e.typing=!1,e.emit("typing",e.typing)},e.prototype._rpc=function(t,e,n){return this.chat.signal.conn.rpc(t,e,n)},n=function(t,e,n){var r,i,o,s;for(o=0,i=t.length-1,s=0,r=0;o<=i;)if(s=o+i>>1,(r=n(t[s],e))<0)o=s+1;else{if(!(r>0))return s;i=s-1}return~o},r=function(t,e,n){var r,i,o,s;for(o=e,s=e,r=t.length,i=[];n<=r;)s=t[n],t[n]=o,o=s,i.push(n++);return i},e}(i),t.exports=r},function(t,e,n){var r,i,o=function(t,e){function n(){this.constructor=t}for(var r in e)s.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;r=n(0),i=function(t){function e(t,n){this.id=n,e.__super__.constructor.apply(this,arguments),this.role="user",this.state=null,this.seen=0,this.seenId=null,this.typing=!1,this._lastTypingSent=0,this.sendTyping=function(e){return function(n){var r,i,o;if(!((i=Date.now())-e._lastTypingSent<7e3&&n===e.typing))return e.typing=n,e._lastTypingSent=i,r="_c."+t.id,null!=(o=t.chat.signal.channels[r])?o.publish({type:"typing",data:n}):void 0}}(this)}return o(e,t),e.prototype._update=function(t){var e,n,r,i,o;for(e=!1,o=["role","seen","seenId","state"],n=0,i=o.length;n<i;n++)r=o[n],this[r]!==t[r]&&(this[r]=t[r],e=!0);return e},e.prototype.updateState=function(t){return this.state!==t&&(this.state=t,this.emit("stateSet"),!0)},e.prototype.updateSeen=function(t,e){var n,r;return!!t&&(null==t.sending&&(n=null!=(r=t.id)?r:t,this.seenId!==n&&(this.seenId=n,null==e&&(e=Date.now()),t.created>e&&(e=t.created),this.seen=e,this.emit("seenSet"),!0)))},e}(r),t.exports=i},function(t,e){var n;n=function(){function t(t){var e,n;this.id=null,this.from=null,this.text=null,this.data=null,this.created=0;for(e in t)n=t[e],this[e]=n}return t.prototype._update=function(t){var e,n,r,i,o;for(e=!1,o=["text","data","sending","failed","progress","total"],n=0,i=o.length;n<i;n++)r=o[n],this[r]!==t[r]&&(this[r]=t[r],e=!0);return e},t}(),t.exports=n},function(t,e,n){var r,i,o;i=n(4),r=function(){function t(e){this.conv=e,this.m={id:t._uniqueId(),created:Date.now(),from:this.conv.me.id,text:null,data:null,sending:!1,failed:!0}}var e,n,r;return t.prototype._export=function(){var t,e,n,r,i;for(i={},r=["text","data"],t=0,n=r.length;t<n;t++)e=r[t],this.m[e]&&(i[e]=this.m[e]);return i},t.prototype.hasAttachment=function(){return null!=this.attachFile},t.prototype.text=function(t){return this.m.text=t,this},t.prototype.attach=function(t){return this.attachFile=t,this.m.progress=0,this.m.total=-1,this},t.prototype.send=function(t){return this.m.sending=!0,this.m.failed=!1,this.hasAttachment()?this._loadAttachmentAndThumbnail(function(e){return function(n){return e.conv._applyMessage(e.m,1),n?e._fail(n,t):e._getUploadParams(function(n,r){return n?e._fail(n,t):e._uploadAttachmentAndThumbnail(r,function(n){return n?e._fail(n,t):e._send2(t)})})}}(this)):(this.conv._applyMessage(this.m,1),void this._send2(t))},t.prototype._send2=function(t){return"::_fail"===this.m.text?void setTimeout(function(e){return function(){return e._fail("big error",t)}}(this),1e3):this.conv.send(this._export(),function(e){return function(n,r){return console.log("Outgoing.send2 done",n,r),n?e._fail(n,t):(e.conv._applyMessage(e.m,-1),"function"==typeof t?t(null,r):void 0)}}(this))},t.prototype._fail=function(t,e){return this.m.sending=!1,this.m.failed=!0,console.log("Failed message",this),this.conv._applyMessage(this.m,0),"function"==typeof e?e(t):void 0},t.prototype._getUploadParams=function(t){var e,n;return null==(null!=(e=this.m.data)?e.type:void 0)?t("Attachment type is not specified",null):this.conv.chat._prepareAttachment(this.m.data.type,null!=(n=this.thumbBlob)?n.type:void 0,t)},t.prototype._loadAttachmentAndThumbnail=function(t){return i.readFileAsArrayBuffer(this.attachFile,function(e){return function(n,r,i){return n&&console.log("Read file ",r,"err=",n),null!=n?t(n):e._handleAttachmentFileLoaded(r,i,t)}}(this))},t.prototype._uploadAttachmentAndThumbnail=function(e,n){var r,i,o;return r=this.attachFile,i=0,o=e.uploads.attach,t.uploadFile(o.endpoint,o.params,r,function(r){return function(s){return s&&console.log("Main attach uploaded err=",s),null!=s?n(s):(r.m.data.attach=e.urls.attach,null==r.m.data.thumb||null==r.thumbBlob?n(null):(o=e.uploads.thumb,t.uploadFile(o.endpoint,o.params,r.thumbBlob,function(t){return t&&console.log("Thumb uploaded err=",t),null!=t?n(t):(r.m.data.thumb=e.urls.thumb,n(null))},function(t,e){return r.m.progress=t+i,r.m.total=e+i,r.conv._applyMessage(r.m,0)})))}}(this),function(t){return function(e,n){return i=e,t.m.progress=e,t.m.total=n,t.conv._applyMessage(t.m,0)}}(this))},t.prototype._handleAttachmentFileLoaded=function(t,e,n){var r,i,o,s,a,u,c,l;return l=null!=(u=null!=t?t.type:void 0)?u:"",o=0===l.indexOf("image/"),s=0===l.indexOf("video/"),i=0===l.indexOf("audio/"),o||s?(r=new Blob([e],t),c=(window.URL||window.webkitURL).createObjectURL(r),a=null,o?(a=new Image,a.onload=function(e){return function(){return e._attachmentMediaLoaded(a,t,n)}}(this)):(a=document.createElement("video"),a.setAttribute("preload",""),a.setAttribute("muted",""),a.onloadedmetadata=function(t){return function(){return console.log("Video meta loaded",a.videoWidth,a.videoHeight,a.duration)}}(),a.onloadeddata=function(e){return function(){return console.log("Video loaded",a),e._attachmentMediaLoaded(a,t,n)}}(this),a.onerror=function(e){return function(){return console.log("Error on video loading. Still can send the file"),e._attachmentMediaLoaded(a,t,n)}}(this)),a.src=c):i?(this.m.data={type:t.type},n(null)):n("Cannot handle files with type"+l)},t.prototype._attachmentMediaLoaded=function(e,n,r){return(window.URL||window.webkitURL).revokeObjectURL(e.src),t.createThumbnail(e,function(t){return function(e,o){return e&&console.log("Thumb created err=",e),null!=e?r(e):(null!=o&&(t.thumbBlob=i.dataUrlToBlob(o)),t.m.data={type:n.type,attach:o,thumb:o},r(null))}}(this))},r=Math.floor(65535*Math.random()),n=Math.floor(16777215*Math.random()),e=0,t._uniqueId=function(){var t,i,o,s,a;return e=e+1&16777215,a=Math.floor(Date.now()/1e3),s=a.toString(16),s="00000000".substr(0,8-s.length)+s,i=n.toString(16),i="000000".substr(0,6-i.length)+i,o=r.toString(16),o="0000".substr(0,4-o.length)+o,t=e.toString(16),t="000000".substr(0,6-t.length)+t,s+i+o+t},t.createThumbnail=function(t,e){var n,r,i,o,s,a,u,c,l,p;return s=320,o=320,p=null!=(a=null!=t?t.videoWidth:void 0)?a:t.width,l=null!=(u=null!=t?t.videoHeight:void 0)?u:t.height,p>l?p>s&&(l*=s/p,p=s):l>o&&(p*=o/l,l=o),n=document.createElement("canvas"),n.width=p,n.height=l,r=n.getContext("2d"),r.drawImage(t,0,0,p,l),i=n.toDataURL("image/jpeg"),(null!=(c=i.split(":")[1])?c.length:void 0)<2&&(i=null),e(null,i)},t.uploadFile=function(e,n,r,i,s){var a;return a=new o(n,r),a.build(function(n,r,o){return null!=n?i(n):t._upload(e,r,o,i,s)})},t._upload=function(t,e,n,r,i){var o,s,a;return a=new XMLHttpRequest,a.open("POST",t,!0),a.onload=function(t){return r(a.status>=200&&a.status<300?null:{status:a.status,text:a.statusText,info:a.responseText})},a.onerror=function(t){return console.log("xhr error",t),r(t)},a.onabort=function(t){return console.log("xhr cancel"),r(t)},a.onprogress=function(t){return console.log("xhr progress",t)},s=null!=(o=null!=a?a.upload:void 0)?o:null,s&&(s.onload=function(t){return console.log("xhr upload complete",t)},s.onerror=function(t){return console.log("xhr upload error",t)},s.onabort=function(t){return console.log("xhr upload cancel",t)},s.onprogress=function(t){var e;return e=t.lengthComputable?t.total:-1,"function"==typeof i?i(t.loaded,e):void 0}),null!=n&&a.setRequestHeader("Content-Type",n),a.send(e)},t}(),o=function(){function t(t,e){if(!this._needsFormDataShim())return this._createFormData(t,e);this._initMultiPart(t,e)}return t.prototype._createFormData=function(t,e){var n,r;this.fd=new FormData;for(n in t)r=t[n],this.fd.append(n,r);return this.fd.append("file",e)},t.prototype._initMultiPart=function(t,e){var n,r;this.boundary=Array(21).join("-")+(+new Date*(1e16*Math.random())).toString(36),this.parts=[];for(n in t)r=t[n],this._append(n,r);return e instanceof File?this.fileToLoad=e:this._append("file",e)},t.prototype._append=function(t,e,n){return this.parts.push("--"+this.boundary+'\r\nContent-Disposition: form-data; name="'+t+'"'),e instanceof Blob&&(null==n&&(n="blob"),this.parts.push('; filename="'+n+'"\r\nContent-Type: '+e.type)),this.parts.push("\r\n\r\n"),this.parts.push(e),this.parts.push("\r\n")},t.prototype.build=function(t){return null!=this.fd?t(null,this.fd):this._ensureFileLoaded("file",this.fileToLoad,function(e){return function(n){return n?t(n):e._completeMultiPart(t)}}(this))},t.prototype._ensureFileLoaded=function(t,e,n){return null==e?n(null):i.readFileAsArrayBuffer(e,function(e){return function(r,i,o){return r?n(r):(e._append(t,new Blob([o],{type:i.type},i.name)),n(null))}}(this))},t.prototype._completeMultiPart=function(t){var e,n;return this.parts.push("--"+this.boundary+"--"),e=new Blob(this.parts),n=new FileReader,n.onload=function(e){return function(){return t(null,n.result,"multipart/form-data; boundary="+e.boundary)}}(this),n.onerror=function(e){return t(e)},n.readAsArrayBuffer(e)},t.prototype._needsFormDataShim=function(){var t,e;return t=navigator.userAgent,e=navigator.vendor,~t.indexOf("Android")&&~e.indexOf("Google")&&!~t.indexOf("Chrome")&&t.match(/AppleWebKit\/(\d+)/).pop()<=534},t}(),t.exports=r},function(t,e,n){var r,i,o=function(t,e){function n(){this.constructor=t}for(var r in e)s.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;r=n(0),i=function(t){function e(t,n){var r,i;e.__super__.constructor.apply(this,arguments),this.id=null,this.role="user",this.state=null,this.seen=0,this.seenId=null,this.typing=!1;for(r in n)i=n[r],this[r]=i;this.kick=function(e){return function(n){return t.kick(e.id,n)}}(this)}return o(e,t),e.prototype._update=function(t){var e,n,r,i,o;for(e=!1,o=["role","seen","seenId","state"],n=0,i=o.length;n<i;n++)r=o[n],this[r]!==t[r]&&(this[r]=t[r],e=!0);return e},e}(r),t.exports=i},function(t,e,n){var r,i,o=function(t,e){function n(){this.constructor=t}for(var r in e)s.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;r=n(0),i=function(t){function e(t){this.options=t,e.__super__.constructor.apply(this,arguments),null==this.options&&(this.options={}),this.currentId=1,this.callbacks={},this.handlers={},this.queue=[],this.closed=!1,this.reconnectDelay=0,this.keepAliveTimer=null}var n,r,i;return o(e,t),i=1e3,r=3e4,n=25e3,e.prototype.update=function(t){return this.options=t},e.prototype.getHandler=function(t){var e;return null!=(e=this.handlers[t])?e:null},e.prototype.addHandler=function(t,e,n){return this.handlers[t]={id:t,notify:e,rpc:n}},e.prototype.removeHandler=function(t){return delete this.handlers[t]},e.prototype.connect=function(){if(this.closed=!1,null==this.ws)return this.options.url?(this.ws=new WebSocket(this.options.url),this.ws.onopen=function(t){return function(){var e,r,i,o;if(console.log("WS connected"),t.reconnectDelay=0,t.queue.length>0){for(o=t.queue,e=0,r=o.length;e<r;e++)i=o[e],t.ws.send(i);t.queue=[]}return t.keepAliveTimer=setInterval(function(){if(null!=t.ws&&1===t.ws.readyState)return t.ws.send("_ping")},n),t.emit("open")}}(this),this.ws.onmessage=function(t){return function(e){var n,r,i,o,s,a,u,c,l;if("_pong"!==e.data){console.log("WS got msg",e.data),a=null;try{a=JSON.parse(e.data)}catch(t){r=t,console.log("Exception parsing JSON response",r),console.log("  -- RAW ["+e.data+"]")}if(a)return null==a.result&&null==a.error?null!=a.method&&null!=a.params?(console.log("Incoming RPC call",a),(u=a.method.indexOf("."))<0?void console.log("Unknown RPC service",a):(c=a.method.substring(0,u),o=t.getHandler(c),s=a.method,s.startsWith(c)&&(s=s.substring(c.length+1)),null==a.id?(i=null!=o?o.notify:void 0,void(i?i(s,a.params):console.log("Missing notify handler",a))):(i=null!=o?o.rpc:void 0,i?i(s,a.params,function(e,n){var r;return r={jsonrpc:"2.0",id:a.id},null!=e&&(r.error=e),null!=n&&(r.result=n),t._send(r)}):(console.log("Missing rpc handler",a),l={jsonrpc:"2.0",id:a.id,error:{code:-32e3,message:"Cannot handle this rpc call"}},t._send(l))))):console.log("Cannot process WS message",a):null!=a.id?(n=t.callbacks[a.id],delete t.callbacks[a.id],n(a.error,a.result)):void 0}}}(this),this.ws.onclose=function(t){return function(){if(console.log("Rpc ws closed"),t.keepAliveTimer&&(clearInterval(t.keepAliveTimer),t.keepAliveTimer=null),!t.closed)return t.ws=null,t.reconnectDelay*=2,t.reconnectDelay=Math.max(t.reconnectDelay,i),t.reconnectDelay=Math.min(t.reconnectDelay,r),console.log("Schedule rpc reconnect in ",t.reconnectDelay,"ms"),t.queue=[],setTimeout(function(){if(!t.closed)return t.connect()},t.reconnectDelay),t.emit("close")}}(this),this.ws.onerror=function(t){return function(){return console.log("Rpc ws got error. Socket state="+t.ws.readyState)}}(this)):void console.log("WsRpc.connect() URL not specified")},e.prototype.rpc=function(t,e,n){var r;return null==this.ws&&this.connect(),r={jsonrpc:"2.0",method:t,params:e},n&&(r.id=this.currentId++,this.callbacks[r.id]=n),this._send(r)},e.prototype._send=function(t){var e;return e=JSON.stringify(t),null!=this.ws&&1===this.ws.readyState?this.ws.send(e):this.queue.push(e)},e.prototype.disconnect=function(){var t;return this.closed=!0,null!=(t=this.ws)&&t.close(),this.ws=null},e}(r),t.exports=i},function(t,e,n){t.exports={version:"2.0.0-beta.3",AccessToken:n(6),Chat:n(5),Signal:n(7),Video:n(8)}},function(t,e,n){var r,i,o,s,a=function(t,e){function n(){this.constructor=t}for(var r in e)u.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},u={}.hasOwnProperty;i=n(0),o=n(17),s=n(18),r=function(t){function e(t,r,i,s){var a,u;this.signal=t,this.id=r,this.options=i,e.__super__.constructor.apply(this,arguments),null==this.options&&(this.options={}),null==(a=this.options).presence&&(a.presence=!1),u=s.split(n)[0],this.me=new o(this,s,u),this.participants={}}var n;return a(e,t),n="/",e.prototype._handleRpcNotify=function(t,e){var r,i,o,a,u,c;switch(r=null!=e?e.from:void 0,a=null!=(u=this.participants)?u[r]:void 0,t){case"publish":case"send":return e.state?a?(a.state=e.state,a.emit("state",a.state)):console.log("Error - got state update for unknown participant",t,e):a?a.emit("message",e):this.emit("message",e);case"join":case"join_back":if(console.log("Channel join from remote",e),o=0,a||(o=1,i=null!=r&&null!=(c=r.split(n))?c[0]:void 0,a=new s(this,r,i),this.participants[r]=a),this.emit("participant",a,o),this.me.state)return a.send({state:this.me.state});break;case"leave":if(console.log("Channel leave from remote",e),a)return delete this.participants[r],this.emit("participant",a,-1)}},e.prototype.leave=function(){return this.signal._leave(this.id)},e.prototype.publish=function(t){return t.id=this.id,this.signal.rpc("publish",t)},e}(i),t.exports=r},function(t,e,n){var r,i,o=function(t,e){function n(){this.constructor=t}for(var r in e)s.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;r=n(0),i=function(t){function e(t,n,r){this.channel=t,this.id=n,this.identity=r,e.__super__.constructor.apply(this,arguments),this.state=null}return o(e,t),e.prototype.updateState=function(t){if(t!==this.state)return this.state=t,this.channel.signal.rpc("publish",{id:this.channel.id,state:this.state}),this.emit("state",this.state),console.log("Update my state",this.id,this.state)},e}(r),t.exports=i},function(t,e,n){var r,i,o=function(t,e){function n(){this.constructor=t}for(var r in e)s.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;r=n(0),i=function(t){function e(t,n,r){this.channel=t,this.id=n,this.identity=r,e.__super__.constructor.apply(this,arguments)}return o(e,t),e.prototype.send=function(t){return t.to=this.id,t.id=this.channel.id,this.channel.signal.rpc("send",t)},e}(r),t.exports=i},function(t,e,n){var r,i,o,s=function(t,e){function n(){this.constructor=t}for(var r in e)a.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},a={}.hasOwnProperty;r=n(0),o=n(1),i=function(t){function e(t,n){this.signal=t,this.capture=n,e.__super__.constructor.apply(this,arguments),this.id=this.signal.id,this.pub={}}return s(e,t),e.prototype.publish=function(t){var e,n,r,i,s,a;for(t=null!=t?t:{},i=o.MEDIA_KINDS,e=0,r=i.length;e<r;e++)n=i[e],null==t[n]&&(t[n]=null!=(s=null!=(a=this.pub)?a[n]:void 0)&&s);return this.capture.request(t,function(e){return function(r){var i,o,s;for(r&&(console.log("Error getting local media",r),e.emit("error","Unable to get local media")),s=["audio","video","screen"],i=0,o=s.length;i<o;i++)n=s[i],t[n]=e.capture.options[n]&&!1!==t[n];return e.pub=t,e.signal.updateState({pub:e.pub}),e.emit("change")}}(this))},e}(r),t.exports=i},function(t,e,n){var r,i,o,s,a=function(t,e){function n(){this.constructor=t}for(var r in e)u.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},u={}.hasOwnProperty;r=n(0),s=n(1),o=n(2),i=function(t){function e(t,r){this.signal=t,this.session=r,e.__super__.constructor.apply(this,arguments),this.id=this.signal.id,this.pub={},this.sub={},this.subTo={},this.dirs={},this.rtc=null,this.signal.on("state",function(t){return function(e){return console.log("Got remote state",t.id,e),t.pub=n(t.pub,null!=e?e.pub:void 0),console.log(" - updated remote state",t.pub),t._update()}}(this)),this.signal.on("message",function(t){return function(e){switch(e.type){case"subscribe":return t.sub=n(t.sub,e.data),t._update();case"offerAnswer":return t.rtc?t.rtc.gotRemoteOfferAnswer(e.data):(console.log("Warning - no RTC to handle signal",e,t),t._pendingOfferAnswer=e.data);case"icecandidate":return t.rtc?t.rtc.gotRemoteIceCandidate(e.data):(console.log("Warning - no RTC to handle signal",e,t),null==t._pendingIceCandidates&&(t._pendingIceCandidates=[]),t._pendingIceCandidates.push(e.data))}}}(this))}var n;return a(e,t),n=function(t,e){var n,r,i,o,a,u;for(o=s.MEDIA_KINDS,n=0,i=o.length;n<i;n++)r=o[n],t[r]=null!=(a=null!=(u=null!=e?e[r]:void 0)?u:t[r])&&a;return t},e.prototype._destroy=function(){var t;return delete this._pendingOfferAnswer,delete this._pendingIceCandidates,null!=(t=this.rtc)&&t.stop(),this.rtc=null},e.prototype.subscribe=function(t){return this.subTo=n(this.subTo,t),console.log("Subscribe to remote",this.subTo,t),this.signal.send({type:"subscribe",data:this.subTo}),this._update()},e.prototype._update=function(){var t,e,n,r,i,o,a,u,c,l,p,h;for(c="p2p"===this.session.options.mode,i=this.session.me.pub,o=this.subTo,a=!1,p=s.MEDIA_KINDS,e=0,r=p.length;e<r;e++)n=p[e],h=(null!=i?i[n]:void 0)&&this.sub[n],l=this.pub[n]&&(null!=o?o[n]:void 0),t=null,t=h?l?"sendrecv":"sendonly":l?"recvonly":"inactive",u=this.dirs[n],console.log("Media",this.id,n,t,h,l,"old=",u,this.dirs[n]),t!==u&&(a=!0,this.dirs[n]=t);return a&&c&&this._scheduleRtcReneg(),this.emit("change")},e.prototype._scheduleRtcReneg=function(){return delete this._pendingOfferAnswer,delete this._pendingIceCandidates,this._ensureRtcTimer&&clearTimeout(this._ensureRtcTimer),this._ensureRtcTimer=setTimeout(function(t){return function(){return delete t._ensureRtcTimer,t._ensureRtcReneg()}}(this),100)},e.prototype._ensureRtcReneg=function(){var t,e,n,r,i,o,a,u,c,l,p,h,d;for(u=!1,d={},l={},p=s.MEDIA_KINDS,n=0,o=p.length;n<o;n++)switch(i=p[n],e=this.dirs[i],d[i]=l[i]=!1,"inactive"!==e&&(u=!0),e){case"sendrecv":d[i]=l[i]=!0;break;case"sendonly":d[i]=!0;break;case"recvonly":l[i]=!0}if(c=this.session.me.id<this.id,console.log("ensureRtcReneg",c,d,l,this.dirs),this.rtc)return u?this.rtc.update(d,l):(console.log("Delete Connection with",this.id),this._destroy());if(u&&(!0,console.log("Create Connection with",this.id,this.dirs),c?console.log("Send Offer"):console.log("Wait for Offer"),this.rtc=this._createP2pRtc(c),this.rtc.update(d,l),null!=this._pendingOfferAnswer&&(this.rtc.gotRemoteOfferAnswer(this._pendingOfferAnswer),delete this._pendingOfferAnswer),null!=this._pendingIceCandidates)){for(h=this._pendingIceCandidates,r=0,a=h.length;r<a;r++)t=h[r],this.rtc.gotRemoteIceCandidate(t);return delete this._pendingIceCandidates}},e.prototype._createP2pRtc=function(t){var e;return e=this._createRtc(t),e.on("offerAnswer",function(t){return function(e){return t.signal.send({type:"offerAnswer",data:e})}}(this)),e.on("icecandidate",function(t){return function(e){return t.signal.send({type:"icecandidate",data:e})}}(this)),e.on("video",function(t){return function(e,n){return t.emit("video",e,n)}}(this)),e},e.prototype._createSfuRtc=function(){var t;return t=this._createRtc(!1),t.on("offerAnswer",function(t){return function(e){return t._sendToSfu("start",{data:e,sub:t.subTo})}}(this)),t.on("icecandidate",function(t){return function(e){return t._sendToSfu("trickle",{data:e})}}(this)),t.on("video",function(t){return function(e,n){return t.emit("video",e,n)}}(this)),t},e.prototype._createRtc=function(t){var e,n;return e={getLocalStreams:function(t){return function(e){return t.session.me.capture.getStreams(e)}}(this),getIceServers:this.session.getIceServers},n=new o,n.init(t,e),n},e.prototype._subscribeFromSfu=function(t){var e;return null!=(e=this.rtc)&&e.stop(),this.rtc=null,this.rtc=this._createSfuRtc(),this.rtc.update({},{}),this.rtc.gotRemoteOfferAnswer(t)},e.prototype._sendToSfu=function(t,e){return e.to=this.signal.id,e.id=this.session.id,this.session.channel.signal.conn.rpc("video.session."+t,e)},e}(r),t.exports=i},function(t,e,n){var r,i,o,s=function(t,e){function n(){this.constructor=t}for(var r in e)a.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},a={}.hasOwnProperty;r=n(0),i=n(2),o=function(t){function e(){e.__super__.constructor.apply(this,arguments),this.options={audio:!1,video:!1,screen:!1},this.preparingScreen=!1,this.preparingMedia=!1,this.errorScreen=null,this.errorMedia=null,this.cbs=[],this.localStream=null,this.localEl=null,this.localScreenStream=null}return s(e,t),e.prototype.getStreams=function(t){var e;return e=[],(t.audio||t.video)&&this.localStream&&e.push(this.localStream),t.screen&&this.localScreenStream&&e.push(this.localScreenStream),e},e.prototype.request=function(t,e){return this._prepareScreenSharing(null!=t?t.screen:void 0,function(n){return function(r){var i,o,s,a;return r&&console.log("RtcCapture.request: Could not get ScreenSharing",r),i=null!=(s=t.audio)?s:n.options.audio,o=null!=(a=t.video)?a:n.options.video,n._prepareCameraMic(i,o,function(t){return t&&console.log("RtcCapture.request: Could not get audio/video",t),n._check(e)})}}(this))},e.prototype._check=function(t){var e,n,r,i,o,s;if(this.preparingScreen||this.preparingMedia)return void this.cbs.push(t);if(n=this.errorMedia,n||this.localStream||(n=this.errorScreen),t(n),this.cbs.length>0){for(s=this.cbs,this.cbs=[],o=[],r=0,i=s.length;r<i;r++)e=s[r],o.push(e(n));return o}},e.prototype.stop=function(){var t;return this.localScreenStream&&(i.stopMediaStream(this.localScreenStream),this.localScreenStream=null),this.localStream&&(i.stopMediaStream(this.localStream),this.localStream=null),this.localEl&&(t=this.localEl,this.localEl=null,null!=t.src&&(t.src=""),this.emit("video",t,-1)),this.options={audio:!1,video:!1,screen:!1}},e.prototype._getScreenSharingOpts=function(t){var e,n;return null!=("undefined"!=typeof navigator&&null!==navigator?navigator.mozGetUserMedia:void 0)?(n={video:{mozMediaSource:"window",mediaSource:"window"}},t(null,n)):(e=function(r){var i;if(i=null!=r?r.data:void 0,console.log("WebApp.gotMessage",i),"completed"===(null!=i?i.state:void 0))return console.log("WebRTC onmsg done"),window.removeEventListener("message",e,!1),n={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:r.data.streamId,maxWidth:window.screen.width,maxHeight:window.screen.height}}},t(null,n)},window.addEventListener("message",e,!1),window.postMessage({requestId:100,data:["screen","window"]},"*"))},e.prototype._prepareScreenSharing=function(t,n){return!1===t&&this.localScreenStream?(this.localScreenStream=null,n(null)):!0==!t?n(null):(this.options.screen=!0,this.localScreenStream?n(null):this.preparingScreen?n(null):(this.preparingScreen=!0,this._getScreenSharingOpts(function(t){return function(r,i){return null!=r?(t.preparingScreen=!1,t.errorScreen=r,n(r)):e.getUserMedia(i,function(e,r){return t.preparingScreen=!1,null!=e&&(t.errorScreen=e),null==e&&(t.localScreenStream=r),n(e)})}}(this))))},e.prototype._prepareCameraMic=function(t,n,r){var i;return this.options.audio===t&&this.options.video===n?r(null):this.preparingMedia?r(null):t||n?(this.options.audio=t,this.options.video=n,i={audio:this.options.audio,video:this.options.video},this.preparingMedia=!0,e.getUserMedia(i,function(t){return function(e,n){return t.preparingMedia=!1,null!=e&&(t.errorMedia=e),t._handleLocalCameraMicStream(n),r(e)}}(this))):(this.options.audio=this.options.video=!1,this._handleLocalCameraMicStream(null),r(null))},e.prototype._handleLocalCameraMicStream=function(t){var e,n,r;return n=this.localStream,this.localStream=t,n&&n!==t&&i.stopMediaStream(n),e=null!=(r=this.localEl)?r:null,this.options.video&&t!==n?(e||(e=document.createElement("video"),e.setAttribute("autoplay","true"),e.setAttribute("muted","true"),e.muted=!0,this.emit("video",e,1)),this.localEl=i.attachMediaStream(e,t)):this.options.video||null==e?void 0:(this.localEl=null,e.src="",this.emit("video",e,-1))},e.getUserMedia=function(t,e){var n,r,i,o,s;return s=window,r=navigator,n=null,!n&&(null!=s?s.getUserMedia:void 0)&&(n=s.getUserMedia.bind(s)),!n&&r&&(n=null!=(i=null!=(o=r.getUserMedia)?o:r.mozGetUserMedia)?i:r.webkitGetUserMedia)&&(n=n.bind(r)),null==n?e("WebRTC not supported. Could not find getUserMedia()"):n(t,function(t){return e(null,t)},e)},e}(r),t.exports=o},function(t,e,n){var r,i,o,s,a,u,c=function(t,e){function n(){this.constructor=t}for(var r in e)l.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},l={}.hasOwnProperty;r=n(0),u=n(1),i=n(19),o=n(20),s=n(2),a=function(t){function e(t,n,r,s,a){var u;this.id=t,this.options=n,this.channel=r,this.getIceServers=a,e.__super__.constructor.apply(this,arguments),null==this.options&&(this.options={}),null==(u=this.options).mode&&(u.mode="p2p"),this.me=new i(this.channel.me,s),this.participants={},this.rtc=null,this.me.on("change",function(t){return function(){var e,n,r,i;"sfu"===t.options.mode&&t._updateForSfu(t.me.pub),r=t.participants,i=[];for(e in r)n=r[e],i.push(n._update());return i}}(this)),this.channel.on("participant",function(t){return function(e,n){var r;return console.log("Session participant",n,e),r=t.participants[e.id],n>0?(r=new o(e,t),t.participants[e.id]=r,r.on("video",function(e,n){return t.emit("video",e,r,n)}),t.emit("participant",r,n)):n<0?r?(delete t.participants[e.id],r._destroy(),t.emit("participant",r,n)):console.log("Error - cannot find Video Session Participant for",e):void 0}}(this))}return c(e,t),e.prototype._destroy=function(){var t,e,n;e=this.participants;for(t in e)n=e[t],n._destroy();return this.participants={}},e.prototype.leave=function(){return this.channel.leave()},e.prototype._updateForSfu=function(t){var e,n,r,i,o,a,c,l,p,h;for(a=!1,o=!1,c=null!=(l=this.rtc)?l.sendOpts:void 0,p=u.MEDIA_KINDS,n=0,i=p.length;n<i;n++)r=p[n],!0===t[r]&&(a=!0),t[r]!==(null!=c?c[r]:void 0)&&(o=!0);if((a||o)&&this.rtc&&(this.rtc.stop(),this.rtc=null,o=!0),a?this.rtc||(o=!0,e={getLocalStreams:function(t){return function(e){return t.me.capture.getStreams(e)}}(this),getIceServers:this.getIceServers},this.rtc=new s,this.rtc.init(!0,e),this.rtc.on("offerAnswer",function(e){return function(n){return e._sendToSfu("publish",{data:n,pub:t})}}(this)),this.rtc.on("icecandidate",function(t){return function(e){return t._sendToSfu("trickle",{data:e})}}(this))):this.rtc&&(null!=(h=this.rtc)&&h.stop(),this.rtc=null),o)return this.rtc?this.rtc.update(t,{}):this._sendToSfu("publish",{pub:t})},e.prototype._sendToSfu=function(t,e){return e.id=this.id,this.channel.signal.conn.rpc("video.session."+t,e)},e}(r),t.exports=a}])});
//# sourceMappingURL=bit6.min.js.map