/*! bit6 - 2.0.0-beta.8 - 2018-01-03T23:18:52.839Z */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.bit6=e():t.bit6=e()}(this,function(){return function(t){function e(o){if(n[o])return n[o].exports;var r=n[o]={i:o,l:!1,exports:{}};return t[o].call(r.exports,r,r.exports,e),r.l=!0,r.exports}var n={};return e.m=t,e.c=n,e.d=function(t,n,o){e.o(t,n)||Object.defineProperty(t,n,{configurable:!1,enumerable:!0,get:o})},e.n=function(t){var n=t&&t.__esModule?function(){return t.default}:function(){return t};return e.d(n,"a",n),n},e.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},e.p="",e(e.s=8)}([function(t,e){var n,o=[].slice;n=function(){function t(){this._events={}}return t.prototype.emit=function(){var t,e,n,r,i,s;if(e=arguments[0],t=2<=arguments.length?o.call(arguments,1):[],!this._events[e])return!1;for(s=this._events[e],n=0,r=s.length;n<r;n++)i=s[n],i.apply(null,t);return!0},t.prototype.addListener=function(t,e){var n;return this.emit("newListener",t,e),(null!=(n=this._events)[t]?n[t]:n[t]=[]).push(e),this},t.prototype.on=t.prototype.addListener,t.prototype.once=function(t,e){var n;return n=function(o){return function(){return o.removeListener(t,n),e.apply(null,arguments)}}(this),this.on(t,n),this},t.prototype.removeListener=function(t,e){var n;return this._events[t]?(this._events[t]=function(){var o,r,i,s;for(i=this._events[t],s=[],o=0,r=i.length;o<r;o++)(n=i[o])!==e&&s.push(n);return s}.call(this),this):this},t.prototype.off=t.prototype.removeListener,t.prototype.removeAllListeners=function(t){return delete this._events[t],this},t}(),t.exports=n},function(t,e){t.exports={MEDIA_KINDS:["audio","video","screen","data"]}},function(t,e,n){var o,r,i,s=function(t,e){function n(){this.constructor=t}for(var o in e)u.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},u={}.hasOwnProperty;o=n(0),i=n(5),r=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return s(e,t),e.prototype.init=function(t,e){return this.offeror=t,this.context=e,this.pc=null,this.remoteEls={},this.outgoingTransfer=null,this.incomingTransfer=null,this.offerQueue=[]},e.prototype.update=function(t,e){var n,o,r;if(this.sendOpts=t,this.recvOpts=e,console.log("Rtc.update send=",this.sendOpts,"recv=",this.recvOpts,"offeror=",this.offeror),this.offeror&&this._preparePeerConnection())return this.sendOpts.data&&this.recvOpts.data&&null==this.dc&&this._createDataChannel(),r={},r.offerToReceiveAudio=null!=(n=this.recvOpts.audio)&&n,r.offerToReceiveVideo=null!=(o=this.recvOpts.video)&&o,this.pc.createOffer(function(t){return function(e){return t.offerQueue.push(e),1===t.offerQueue.length?t._setLocalAndSendOfferAnswer(e):console.log("Saving offer for later, pending offers",t.offerQueue.length)}}(this),function(t){return function(t){return console.log("CreateOffer error",t)}}(),r)},e.prototype.stop=function(){var t,e,n,o,r;n=this.remoteEls;for(e in n)t=n[e],null!=t.src&&(t.src=""),this._removeDomElement(t);return this.remoteEls={},null!=(o=this.dc)&&o.close(),this.dc=null,null!=(r=this.pc)&&r.close(),this.pc=null},e.prototype.getRemoteTrackKinds=function(){var t,e,n,o,r,i,s,u,a,c,l,p;for(e=!1,t=!1,l=null!=(s=null!=(u=this.pc)&&"function"==typeof u.getRemoteStreams?u.getRemoteStreams():void 0)?s:[],n=0,r=l.length;n<r;n++)for(c=l[n],a=c.getTracks(),o=0,i=a.length;o<i;o++)p=a[o],"video"!==p.kind||p.muted||(e=!0),"audio"===p.kind&&(t=!0);return{audio:t,video:e}},e.prototype._preparePeerConnection=function(){var t,e,n,o,r,i,s;if(null==this.pc&&(this.pc=this._createPeerConnection()),null==this.pc)return!1;for(r={},i=["audio","screen","video"],t=0,n=i.length;t<n;t++)e=i[t],r[e]=this.sendOpts[e];return o=this.context.getLocalStreams(r),null!=(null!=(s=this.pc)?s.getSenders:void 0)?this._mozSyncLocalStreams(this.pc,o):this._syncLocalStreams(this.pc,o),!0},e.prototype._syncLocalStreams=function(t,e){var n,o,r,i,s,u,a,c,l;for(l={},u=t.getLocalStreams(),n=0,i=u.length;n<i;n++)c=u[n],l[c.id]=c;for(o=0,s=e.length;o<s;o++)c=e[o],l[c.id]?delete l[c.id]:t.addStream(c);a=[];for(r in l)c=l[r],a.push(t.removeStream(c));return a},e.prototype._mozSyncLocalStreams=function(t,e){var n,o,r,i,s,u,a,c,l,p,h,d,f;for(f={},c=t.getSenders(),n=0,s=c.length;n<s;n++)h=c[n],f[h.track.id]=h;for(o=0,u=e.length;o<u;o++)for(h=e[o],l=h.getTracks(),i=0,a=l.length;i<a;i++)d=l[i],f[d.id]?delete f[d.id]:t.addTrack(d,h);p=[];for(r in f)h=f[r],p.push(t.removeTrack(h));return p},e.prototype._createPeerConnection=function(){var t,e,n,o;try{return n={iceServers:this.context.getIceServers()},o={optional:[{DtlsSrtpKeyAgreement:!0}]},e=new RTCPeerConnection(n,o),e.onicecandidate=function(t){return function(e){return t._handleIceCandidate(e.candidate)}}(this),e.ondatachannel=function(t){return function(e){return t._createDataChannel(e.channel)}}(this),e.onaddstream=function(t){return function(e){return t._handleRemoteStreamAdded(e.stream)}}(this),e.onremovestream=function(t){return function(e){return t._handleRemoteStreamRemoved(e.stream)}}(this),e.onaddtrack=function(t){return function(t){return console.log("onaddtrack",t)}}(),e.onremovetrack=function(t){return function(t){return console.log("onremovetrack",t)}}(),e}catch(e){return t=e,console.log("Failed to create PeerConnection, exception: ",t),null}},e.prototype._createDataChannel=function(t){var e;return t||(e={ordered:!0},t=this.pc.createDataChannel("mydc",e)),this.dc=t,t.binaryType="arraybuffer",t.onopen=function(t){return function(){return t._handleDcOpen()}}(this),t.onclose=function(t){return function(){return t._handleDcClose()}}(this),t.onerror=function(t){return function(e){return t._handleDcError(e)}}(this),t.onmessage=function(t){return function(e){return t._handleDcMessage(e)}}(this)},e.prototype._handleDcOpen=function(){return this.emit("dcOpen")},e.prototype._handleDcClose=function(){if(this.outgoingTransfer||this.incomingTransfer)return this._handleDcError("DataChannel closed")},e.prototype._handleDcError=function(t){var e,n,o,r;for(console.log("Data Channel Error:",t),o=[this.outgoingTransfer,this.incomingTransfer],e=0,n=o.length;e<n;e++)r=o[e],r&&(r.err=t),r&&this.emit("transfer",r);return this.outgoingTransfer=this.incomingTransfer=null},e.prototype._handleDcMessage=function(t){var e,n,o;return e=t.data,this.incomingTransfer?null==e.byteLength?console.log("Error: incoming transfer data",e):(n=this.incomingTransfer._gotChunk(e),this.emit("transfer",this.incomingTransfer),n?this.incomingTransfer=null:void 0):null!=e.byteLength?console.log("Error: incoming transfer not created for:",e):(o=JSON.parse(e),o?(this.incomingTransfer=new i(!1,o),this.emit("transfer",this.incomingTransfer)):console.log("Error: could not parse incoming transfer info:",e))},e.prototype._handleIceCandidate=function(t){return this.emit("icecandidate",t)},e.prototype._handleRemoteStreamAdded=function(t){var n,o,r,i,s,u,a,c;for(t.onaddtrack=function(t){return function(e){return t._handleRemoteTrackAdded(e.target,e.track)}}(this),t.onremovetrack=function(t){return function(e){return t._handleRemoteTrackRemoved(e.target,e.track)}}(this),r=!1,o=!1,u=t.getTracks(),i=0,s=u.length;i<s;i++)c=u[i],"video"!==c.kind||c.muted||(r=!0),"audio"===c.kind&&(o=!0);if(n=null,r?(n="undefined"!=typeof document&&null!==document?document.createElement("video"):void 0,null==n&&(n={srcObject:t}),this.emit("video",n,1)):o&&(n="undefined"!=typeof document&&null!==document?document.createElement("audio"):void 0)&&"plugin"===("undefined"!=typeof window&&null!==window?window.webrtcDetectedType:void 0)&&"undefined"!=typeof document&&null!==document&&null!=(a=document.body)&&a.appendChild(n),n)return"function"==typeof n.setAttribute&&n.setAttribute("autoplay","true"),n=e.attachMediaStream(n,t),this.remoteEls[t.id]=n},e.prototype._handleRemoteStreamRemoved=function(t){var e;if(t.onaddtrack=null,t.onremovetrack=null,e=this.remoteEls[t.id],delete this.remoteEls[t.id],null!=e)return null!=e.src&&(e.src=""),this._removeDomElement(e)},e.prototype._handleRemoteTrackAdded=function(t,e){if("video"===e.kind)return this._handleRemoteStreamRemoved(t),this._handleRemoteStreamAdded(t)},e.prototype._handleRemoteTrackRemoved=function(t,e){if("video"===e.kind)return this._handleRemoteStreamRemoved(t),this._handleRemoteStreamAdded(t)},e.prototype._removeDomElement=function(t){var e,n,o,r,i,s,u,a;if(r=null!=t&&null!=(s=t.nodeName)&&"function"==typeof s.toLowerCase?s.toLowerCase():void 0,n=!1,"object"===r){if(t.children)for(u=t.children,e=0,o=u.length;e<o;e++)i=u[e],"tag"===i.name&&"audio"===i.value&&(n=!0)}else"audio"===r&&(n=!0);return n?null!=(a=t.parentNode)&&"function"==typeof a.removeChild?a.removeChild(t):void 0:this.emit("video",t,-1)},e.prototype._setLocalAndSendOfferAnswer=function(t){return this.pc.setLocalDescription(t,function(e){return function(){return e.emit("offerAnswer",t)}}(this),function(e){return console.log("Error setting PeerConnection localDescription",e,t)})},e.prototype.gotRemoteOfferAnswer=function(t){var e,n;switch(e=new RTCSessionDescription(t),t.type){case"offer":return this._preparePeerConnection(),this.pc.setRemoteDescription(e,function(){return!0},function(t){return console.log("Error setting PeerConnection remoteDescription for offer",t,e)}),this.pc.createAnswer(function(t){return function(e){return t._setLocalAndSendOfferAnswer(e)}}(this),function(t){return function(t){return console.log("CreateAnswer error",t)}}());case"answer":return null!=(n=this.pc)?n.setRemoteDescription(e,function(t){return function(){return t.offerQueue.shift(),t.offerQueue.length>0&&(console.log("sending pending offer, pending offers",t.offerQueue.length),t._setLocalAndSendOfferAnswer(t.offerQueue[0])),!0}}(this),function(t){return console.log("Error setting PeerConnection remoteDescription for answer",t,e)}):void 0}},e.prototype.gotRemoteIceCandidate=function(t){var e,n;return console.log("Adding remote IceCandidate",t),n=new RTCIceCandidate(t),null!=(e=this.pc)?e.addIceCandidate(n):void 0},e.prototype.startOutgoingTransfer=function(t){var e,n,o,r,i,s;return!this.outgoingTransfer&&(!!this.dc&&("open"===this.dc.readyState&&(this.outgoingTransfer=t,this.dc.send(JSON.stringify(t.info)),n=t.data,o=10,e=16384,i=0,s=n.byteLength,r=0,r=setInterval(function(o){return function(){var u,a,c;if(u=!1,t=o.outgoingTransfer,t&&!t.err||(u=!0),!u){if((null!=(c=o.dc)?c.bufferedAmount:void 0)>50*e)return;a=i+e,a>s&&(a=s),o.dc.send(n.slice(i,a)),i=a,t.progress=i,u=i>=s}if(u&&(o.outgoingTransfer=null,clearInterval(r)),t)return o.emit("transfer",t)}}(this),o))))},e.attachMediaStream=function(t,e){var n,o;if(null!=("undefined"!=typeof window&&null!==window?window.attachMediaStream:void 0))return window.attachMediaStream(t,e);o=!1;try{null!=t?t.srcObject:void 0,o=!0}catch(t){n=t,console.log(n)}return o?t.srcObject=e:null!=(null!=t?t.mozSrcObject:void 0)?t.mozSrcObject=e:null!=(null!=t?t.src:void 0)?t.src=URL.createObjectURL(e):console.log("Error attaching stream to element",t),t},e.stopMediaStream=function(t){var e,n,o,r;if(t.stop)t.stop();else if(t.getTracks)for(o=t.getTracks(),e=0,n=o.length;e<n;e++)r=o[e],t.removeTrack(r),r.stop();if(t.release)return t.release()},e}(o),t.exports=r},function(t,e,n){"use strict";function o(t){var e=t.length;if(e%4>0)throw new Error("Invalid string. Length must be a multiple of 4");return"="===t[e-2]?2:"="===t[e-1]?1:0}function r(t){return 3*t.length/4-o(t)}function i(t){var e,n,r,i,s,u=t.length;i=o(t),s=new p(3*u/4-i),n=i>0?u-4:u;var a=0;for(e=0;e<n;e+=4)r=l[t.charCodeAt(e)]<<18|l[t.charCodeAt(e+1)]<<12|l[t.charCodeAt(e+2)]<<6|l[t.charCodeAt(e+3)],s[a++]=r>>16&255,s[a++]=r>>8&255,s[a++]=255&r;return 2===i?(r=l[t.charCodeAt(e)]<<2|l[t.charCodeAt(e+1)]>>4,s[a++]=255&r):1===i&&(r=l[t.charCodeAt(e)]<<10|l[t.charCodeAt(e+1)]<<4|l[t.charCodeAt(e+2)]>>2,s[a++]=r>>8&255,s[a++]=255&r),s}function s(t){return c[t>>18&63]+c[t>>12&63]+c[t>>6&63]+c[63&t]}function u(t,e,n){for(var o,r=[],i=e;i<n;i+=3)o=(t[i]<<16)+(t[i+1]<<8)+t[i+2],r.push(s(o));return r.join("")}function a(t){for(var e,n=t.length,o=n%3,r="",i=[],s=0,a=n-o;s<a;s+=16383)i.push(u(t,s,s+16383>a?a:s+16383));return 1===o?(e=t[n-1],r+=c[e>>2],r+=c[e<<4&63],r+="=="):2===o&&(e=(t[n-2]<<8)+t[n-1],r+=c[e>>10],r+=c[e>>4&63],r+=c[e<<2&63],r+="="),i.push(r),i.join("")}e.byteLength=r,e.toByteArray=i,e.fromByteArray=a;for(var c=[],l=[],p="undefined"!=typeof Uint8Array?Uint8Array:Array,h="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",d=0,f=h.length;d<f;++d)c[d]=h[d],l[h.charCodeAt(d)]=d;l["-".charCodeAt(0)]=62,l["_".charCodeAt(0)]=63},function(t,e){t.exports=function(t,e){var n,o,r,i,s,u,a,c,l,p;if(c=t.url,t.qs&&(n=function(){var e,n;e=t.qs,n=[];for(o in e)l=e[o],n.push(o+"="+encodeURIComponent(l));return n}(),a=c.indexOf("?")<0?"?":"&",c+=a+n.join("&")),r=null!=(s=t.method)?s:"get",p=new XMLHttpRequest,p.open(r,c,!0),p.onload=function(n){var o,r,i;if(console.log("xhr complete status="+p.status+" "+p.statusText),i=p.responseText,!(p.status>=200&&p.status<300))return"function"==typeof e?e({status:p.status,text:p.statusText,info:i}):void 0;if(!t.json)return"function"==typeof e?e(null,i):void 0;if(0===i.length)return"function"==typeof e?e(null,null):void 0;try{return r=JSON.parse(i),"function"==typeof e?e(null,r):void 0}catch(t){return o=t,console.log("Error parsing JSON response:",i),"function"==typeof e?e(o):void 0}},p.onerror=function(t){return console.log("xhr error",t),"function"==typeof e?e(t):void 0},p.onabort=function(t){return console.log("xhr cancel"),"function"==typeof e?e(t):void 0},p.onprogress=function(t){return console.log("xhr progress",t)},t.json&&p.setRequestHeader("Content-Type","application/json"),t.headers){u=t.headers;for(o in u)l=u[o],p.setRequestHeader(o,l)}return i=null,t.form&&t.json&&(i=JSON.stringify(t.form)),p.send(i)}},function(t,e,n){var o,r;r=n(3),o=function(){function t(t,e,n){var o;this.outgoing=t,this.info=e,this.progress=0,this.total=null!=(o=this.info.size)?o:0,this.err=null,this.data=null!=n?n:null,this.outgoing||(this.buf=[])}return t.prototype.pending=function(){return this.outgoing&&this.data&&!this.err&&0===this.progress},t.prototype.completed=function(){return this.progress===this.total&&this.data&&!this.err},t.prototype.percentage=function(){return this.total?(100*this.progress/this.total).toFixed(2):0},t.prototype.json=function(t){var e,n,o,r,i,s,u;if(t){for(this.info.type="application/json",u=JSON.stringify(t),e=new Uint8Array(u.length),n=o=0,i=u.length;0<=i?o<i:o>i;n=0<=i?++o:--o)e[n]=u.charCodeAt(n);this.info.size=e.byteLength,this.data=e.buffer}else{if(!1===this.info.type)return null;for(e=new Uint8Array(this.data),u="",n=r=0,s=e.length;0<=s?r<s:r>s;n=0<=s?++r:--r)u+=String.fromCharCode(e[n]);t=JSON.parse(u)}return t},t.prototype._ensureSourceData=function(e){return null!=this.data?e(null):t.readFileAsArrayBuffer(this.info,function(t){return function(n,o,r){return null!=n&&(t.err=n),null!=r&&null!=o&&(t.info=o),null!=r&&(t.data=r),e(n)}}(this))},t.prototype._gotChunk=function(t){return this.buf.push(t),this.progress+=t.byteLength,!(this.progress<this.total)&&(this._prepareReceivedData(),!0)},t.prototype._prepareReceivedData=function(){var t,e,n,o,r,i;for(i=new Uint8Array(this.progress),o=0,r=this.buf,e=0,n=r.length;e<n;e++)t=r[e],i.set(new Uint8Array(t),o),o+=t.byteLength;return this.buf=null,this.data=i.buffer},t.readFileAsArrayBuffer=function(t,e){var n;return n=new FileReader,n.onload=function(o){var r,i;if(n.readyState===FileReader.DONE)return r=o.target.result,console.log(t.name+" - read "+r.byteLength+"b"),i={name:t.name,type:t.type,size:t.size},e(null,i,r)},n.onerror=function(t){return e(t)},n.onabort=function(t){return e(t)},n.readAsArrayBuffer(t)},t.dataUrlToBlob=function(t){var e,n,o,i,s;return o=";base64,",s=null,n=null,t.indexOf(o)<0?(i=t.split(","),n=i[0].split(":")[1],s=decodeURIComponent(i[1])):(i=t.split(o),n=i[0].split(":")[1],e=r.toByteArray(i[1]),s=e.buffer),new Blob([s],{type:n})},t}(),t.exports=o},function(t,e,n){var o,r,i=function(t,e){function n(){this.constructor=t}for(var o in e)s.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;o=n(0),r=function(t){function e(t){this.options=t,e.__super__.constructor.apply(this,arguments),null==this.options&&(this.options={}),this.currentId=1,this.callbacks={},this.handlers={},this.queue=[],this.closed=!1,this.reconnectDelay=0,this.keepAliveTimer=null}var n,o,r;return i(e,t),r=1e3,o=3e4,n=25e3,e.prototype.update=function(t){return this.options=t},e.prototype.getHandler=function(t){var e;return null!=(e=this.handlers[t])?e:null},e.prototype.addHandler=function(t,e,n){return this.handlers[t]={id:t,notify:e,rpc:n}},e.prototype.removeHandler=function(t){return delete this.handlers[t]},e.prototype.connected=function(){var t;return 1===(null!=(t=this.ws)?t.readyState:void 0)&&!this.closed},e.prototype.connect=function(){if(this.closed=!1,null==this.ws)return this.options.url?(this.ws=new WebSocket(this.options.url),this.ws.onopen=function(t){return function(){var e,n,o,r,i;if(console.log("WS connected",t.options.url),t.reconnectDelay=0,t.queue.length>0){for(i=t.queue,e=0,o=i.length;e<o;e++)r=i[e],t.ws.send(r);t.queue=[]}return n=t._getKeepaliveInterval(),n>0&&(t.keepAliveTimer=setInterval(function(){if(null!=t.ws&&1===t.ws.readyState)return t.ws.send("_ping")},n)),t.emit("open")}}(this),this.ws.onmessage=function(t){return function(e){var n,o,r,i,s,u,a,c,l;if("_pong"!==e.data){console.log("WS got msg",e.data),u=null;try{u=JSON.parse(e.data)}catch(t){o=t,console.log("Exception parsing JSON response",o),console.log("  -- RAW ["+e.data+"]")}if(u)return null==u.result&&null==u.error?null!=u.method&&null!=u.params?(console.log("Incoming RPC call",u),(a=u.method.indexOf("."))<0?void console.log("Unknown RPC service",u):(c=u.method.substring(0,a),i=t.getHandler(c),s=u.method,s.startsWith(c)&&(s=s.substring(c.length+1)),null==u.id?(r=null!=i?i.notify:void 0,void(r?r(s,u.params):console.log("Missing notify handler",u))):(r=null!=i?i.rpc:void 0,r?r(s,u.params,function(e,n){var o;return o={jsonrpc:"2.0",id:u.id},null!=e&&(o.error=e),null!=n&&(o.result=n),t._send(o)}):(console.log("Missing rpc handler",u),l={jsonrpc:"2.0",id:u.id,error:{code:-32e3,message:"Cannot handle this rpc call"}},t._send(l))))):console.log("Cannot process WS message",u):null!=u.id?(n=t.callbacks[u.id],n?(delete t.callbacks[u.id],n(u.error,u.result)):console.log("No callback for RPC call",u)):void 0}}}(this),this.ws.onclose=function(t){return function(){if(console.log("Rpc ws closed"),t.keepAliveTimer&&(clearInterval(t.keepAliveTimer),t.keepAliveTimer=null),!t.closed)return t.ws=null,t.reconnectDelay*=2,t.reconnectDelay=Math.max(t.reconnectDelay,r),t.reconnectDelay=Math.min(t.reconnectDelay,o),console.log("Schedule rpc reconnect in ",t.reconnectDelay,"ms"),t.queue=[],setTimeout(function(){if(!t.closed)return t.connect()},t.reconnectDelay),t.emit("close")}}(this),this.ws.onerror=function(t){return function(){return console.log("Rpc ws got error. Socket state="+t.ws.readyState)}}(this)):void console.log("WsRpc.connect() URL not specified")},e.prototype._getKeepaliveInterval=function(){return n},e.prototype.rpc=function(t,e,n){var o;return null==this.ws&&this.connect(),o={jsonrpc:"2.0",method:t,params:e},n&&(o.id=this.currentId++,this.callbacks[o.id]=n),this._send(o)},e.prototype._send=function(t){var e;return e=JSON.stringify(t),null!=this.ws&&1===this.ws.readyState?this.ws.send(e):this.queue.push(e)},e.prototype.disconnect=function(){var t;return this.closed=!0,null!=(t=this.ws)&&t.close(),this.ws=null},e}(o),t.exports=r},function(t,e){var n;n=function(t){var e,n,o,r;for(r="",n=0,o=t.length;n<o;n++)e=t[n],r+="a="+e.candidate+"\r\n";return r},t.exports={generateGUID:function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(t){var e,n;return e=16*Math.random()|0,n="x"===t?e:3&e|8,n.toString(16)})},extractUuidFromSessionId:function(t){var e;return(e=t.lastIndexOf("."))<0||e>=t.length-2?null:(t=t.substring(e+2),t.substring(0,8)+"-"+t.substring(8,12)+"-"+t.substring(12,16)+"-"+t.substring(16,20)+"-"+t.substring(20))},mergeSdp:function(t,e){var o,r,i,s,u,a,c,l;if(0===e.length)return t;for(c=t.sdp,r=[],l=0;(i=c.indexOf("m=",l+1))>=0;)r.push(c.substring(l,i)),l=i;for(r.push(c.substring(l)),c="",u=s=0,a=r.length;s<a;u=++s)o=r[u],c+=o,u>0&&null!=e[u-1]&&(c+=n(e[u-1]));return t.sdp=c,t}}},function(t,e,n){t.exports={version:"2.0.0-beta.8",AccessToken:n(9),Auth:n(10),Chat:n(11),Invite:n(17),Push:n(20),Signal:n(21),Video:n(25)}},function(t,e,n){var o,r,i,s=function(t,e){function n(){this.constructor=t}for(var o in e)u.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},u={}.hasOwnProperty;i=n(3),r=n(0),o=function(t){function e(t){e.__super__.constructor.apply(this,arguments),this.update(t)}var n;return s(e,t),n="/",e.prototype.destroy=function(){return this.clear()},e.prototype.clear=function(){var t,e,n,o,r;for(this.expTimer&&(clearTimeout(this.expTimer),this.expTimer=null),o=["token","claims","identity","device"],r=[],t=0,e=o.length;t<e;t++)n=o[t],r.push(this[n]=null);return r},e.prototype.update=function(t){var o,r,i,s,u,a,c,l,p;a=t.split("."),i=null!=a?a[1]:void 0;try{i=e.base64urlDecode(i),i&&(r=JSON.parse(i)),o=null!=r&&null!=(c=r.sub)?c.split(n):void 0,this.clear(),this.token=t,this.claims=r,(null!=o?o.length:void 0)>0&&(this.identity=null!=o?o[0]:void 0),(null!=o?o.length:void 0)>1&&(this.device=null!=o?o[1]:void 0)}catch(t){return u=t,console.log("Error parsing AccessToken JWT claims",u,i),!1}return this.emit("updated",this),(null!=(l=this.claims)?l.exp:void 0)>0&&(s=1e3*(null!=(p=this.claims)?p.exp:void 0)-Date.now()-1e4,s<0&&(s=0),this.expTimer=setTimeout(function(t){return function(){return t.expTimer=null,t.emit("expired",t)}}(this),s)),!0},e.base64urlDecode=function(t){var e;return t?(t+=new Array(4-(t.length+3&3)).join("="),e=i.toByteArray(t),String.fromCharCode.apply(null,e)):null},e}(r),t.exports=o},function(t,e,n){var o,r;r=n(4),o=function(){function t(t){var e;if(this.options=t,!(null!=(e=this.options)?e.apikey:void 0))throw"Missing required apikey"}return t.prototype.strategies=function(t){return this._api("get","/strategies",null,null,t)},t.prototype.anonymous=function(t,e){return this._api("post","/strategies/anonymous/token",null,t,e)},t.prototype.facebook=function(t,e){return this._api("post","/strategies/facebook/token",null,t,e)},t.prototype._api=function(t,e,n,o,i){var s,u,a,c;return u=null!=(c=this.options.env)?c:"prod",s="https://api."+u+".bit6.com","local"===u&&(s="http://localhost:8000"),s+="/app/auth/v1",a={json:!0,method:t,url:s+e+"?apikey="+this.options.apikey},n&&(a.qs=n),o&&(a.form=o),r(a,i)},t}(),t.exports=o},function(t,e,n){var o,r,i,s=function(t,e){function n(){this.constructor=t}for(var o in e)u.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},u={}.hasOwnProperty;i=n(0),r=n(12),o=function(t){function e(t,n){var o;this.signal=t,this.options=n,e.__super__.constructor.apply(this,arguments),null==this.options&&(this.options={}),null==(o=this.options).sync&&(o.sync=!1),this.conversations={},this.signal.on("channel",function(t){return function(t,e){return console.log("Chat onChannel event",e,t.id)}}()),this.signal.conn.addHandler("chat",this._handleRpcNotify.bind(this),null),this._typingTimer=setInterval(function(t){return function(){var e,n,o,r;o=t.conversations,r=[];for(n in o)e=o[n],r.push(e._expireTyping());return r}}(this),1e3),!0!==this.options.sync&&!0!==this.options.sync.conversations||setTimeout(function(t){return function(){return t.fetchConversations()}}(this),50)}var n;return s(e,t),n="/",e.prototype.destroy=function(){var t,e;return clearInterval(this._typingTimer),null!=(t=this.signal)&&null!=(e=t.conn)&&e.removeHandler("chat"),this.signal=null},e.prototype.create=function(t,e){return null==t&&(t={}),this.signal.conn.rpc("chat.conversation.create",t,function(t){return function(n,o){var r;return console.log("chat.conversation.create",n,o),n?"function"==typeof e?e(n):void 0:(null!=o?o.id:void 0)?(r=t._addConversation(o),"function"==typeof e?e(null,r):void 0):"function"==typeof e?e("Cannot create conversation"):void 0}}(this))},e.prototype.join=function(t,e){return this.signal.conn.rpc("chat.conversation.join",{id:t},function(t){return function(n,o){var r;return console.log("chat.conversation.join",n,o),n?"function"==typeof e?e(n):void 0:(null!=o?o.id:void 0)?(r=t._addConversation(o),"function"==typeof e?e(null,r):void 0):"function"==typeof e?e("Cannot join conversation"):void 0}}(this))},e.prototype.leave=function(t,e){var n,o;return(n=this.conversations[t])?(this._removeConversation(n),o={id:t},this.signal.conn.rpc("chat.conversation.leave",o,function(n){return console.log("Left conversation",t),"function"==typeof e?e(n):void 0})):"function"==typeof e?e("No conversation"):void 0},e.prototype.fetchConversations=function(t){return this.signal.conn.rpc("chat.conversation.list",{},function(e){return function(n,o){return console.log("chat.conversation.list",n,o),n||e._applyConversations(o,!0),"function"==typeof t?t(n):void 0}}(this))},e.prototype._applyConversations=function(t,e){var n,o,r,i,s,u,a,c;for(c=null,s=this.conversations,e&&(c=Object.assign({},this.conversations),s={}),o=0,i=t.length;o<i;o++)u=t[o],n=this.conversations[u.id],n?(s[u.id]=n,e&&delete c[u.id]):(n=this._addConversation(u),s[u.id]=n);if(e){this.conversations=s,a=[];for(r in c)n=c[r],a.push(this._removeConversation(n));return a}},e.prototype._addConversation=function(t){var e,o,i,s;return s=t.id,null!=(e=this.conversations[s])?e:(i="_c."+s,o=this.signal.join(i,{presence:!1}),o.on("message",function(t){return function(t){var o,r;return o=null!=(r=t.from)?r.split(n)[0]:void 0,e._handleRemoteSignal(t,o)}}()),e=new r(this,t),this.conversations[s]=e,this.emit("conversation",e,1),!0!==this.options.sync&&!0!==this.options.sync.participants||e.fetchParticipants(),!0!==this.options.sync&&!0!==this.options.sync.messages||e.fetchMessages(),e)},e.prototype._removeConversation=function(t){var e,n;return delete this.conversations[t.id],e="_c."+t.id,null!=(n=this.signal.channels[e])&&n.leave(),this.emit("conversation",t,-1),t},e.prototype._prepareAttachment=function(t,e,n){var o;return o={type:t,thumb:e},this.signal.conn.rpc("chat.attachment.prepare",o,function(t){return function(t,e){return console.log("chat.attachment.prepare",t,e),n(t,e)}}())},e.prototype._applyParticipant=function(t,e,n){var o;return(o=this.conversations[t])?n<0&&o.me.id===e.id?this._removeConversation(o):o._applyParticipant(e,n):n<0?void 0:this.signal.conn.rpc("chat.conversation.get",{id:t},function(t){return function(e,n){if(console.log("chat.conversation.get",e,n),n)return t._applyConversations([n],!1)}}(this))},e.prototype._applyMessage=function(t,e,n){var o;if(o=this.conversations[t])return o._applyMessage(e,n)},e.prototype._handleRpcNotify=function(t,e){var n,o;switch((null!=e&&null!=(o=e.id)?o.startsWith("_c."):void 0)&&(n=e.id.substring(3)),console.log("Chat.handleRpcNotify",t,e),t){case"participant":case"participant.channel":return this._applyParticipant(n,e.data,e.op);case"message.channel":return this._applyMessage(n,e.data,e.op)}},e}(i),t.exports=o},function(t,e,n){var o,r,i,s,u,a,c=function(t,e){function n(){this.constructor=t}for(var o in e)l.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},l={}.hasOwnProperty;r=n(0),i=n(13),s=n(14),u=n(15),a=n(16),o=function(t){function e(t,n){var o,r,s;this.chat=t,e.__super__.constructor.apply(this,arguments),this.id=null,this.created=0;for(r in n)s=n[r],this[r]=s;o=this.chat.signal.accessToken.identity,this.me=new i(this,o),this.me.on("seenSet",function(t){return function(){return t._sendUpdateMe()}}(this)),this.me.on("stateSet",function(t){return function(e){return t._sendUpdateMe()}}(this)),this.participants={},this.messages=[],this._startedTyping={},this._online={}}var n,o;return c(e,t),e.prototype._update=function(t){var e,n,o,r,i;for(e=!1,i=["state"],r=0,o=i.length;r<o;r++)n=i[r],this[n]!==t[n]&&(this[n]=t[n],e=!0);return e},e.prototype.updateState=function(t,e){return this.state=t,"function"==typeof e?e(null):void 0},e.prototype.leave=function(t){return this.chat.leave(this.id,t)},e.prototype.send=function(t,e){var n;return console.log("Send message to Conversation",t),n={conversation:this.id},n=Object.assign(n,t),this._rpc("chat.message.send",n,function(t){return function(n,o){var r;return n||(r=t._applyMessage(o,1)),"function"==typeof e?e(n,r):void 0}}(this))},e.prototype.compose=function(){return new u(this)},e.prototype.fetchMessages=function(t,e){return null==t&&(t={}),null==t.limit&&(t.limit=50),t.conversation=this.id,this._rpc("chat.message.list",t,function(t){return function(n,o){return n||t._applyMessages(o),"function"==typeof e?e(n,o):void 0}}(this))},e.prototype.getUnreadCount=function(t){var e,o,r,i,s,u;if(u=null!=(s=t.seen)?s:0,0===(r=this.messages.length))return 0;if(i=this.messages[r-1],u>=i.created)return 0;for(o=n(this.messages,{created:u},function(t,e){var n;return n=t.created-e.created,n>0?1:n<0?-1:0}),o>=0?o++:o=~o,e=0;o<r;)this.messages[o].from!==this.me.id&&e++,o++;return e},e.prototype._applyMessages=function(t){var e,n,o,r,i,u,a,c,l,p,h,d,f,g,v,y;for(e=this.messages,r=function(){var e,n,o;for(o=[],n=0,e=t.length;n<e;n++)d=t[n],o.push(new s(d));return o}(),g=[],u=a=0,n=[],y=[];u<e.length&&a<r.length;)o=e[u],i=r[a],o.id<i.id?(g.push(o),u++):o.id>i.id?(g.push(i),n.push(i),a++):(o._update(i)&&y.push(o),g.push(o),u++,a++);for(;u<e.length;)g.push(e[u]),u++;for(;a<r.length;)g.push(r[a]),n.push(r[a]),a++;for(this.messages=g,h=0,c=n.length;h<c;h++)p=n[h],this.emit("message",p,1);for(v=[],f=0,l=y.length;f<l;f++)p=y[f],v.push(this.emit("message",p,0));return v},e.prototype._applyMessage=function(t,e){var r,i,u;if(r=!1,u=new s(t),e>=0){if(this._stopTyping(u.from),0===this.messages.length||u.id>this.messages[this.messages.length-1].id?(this.messages.push(u),r=!0):u.id<this.messages[0].id&&(this.messages.unshift(u),r=!0),r)return this.emit("message",u,e),u}else if(0===this.messages.length||u.id<this.messages[0].id||u.id>this.messages[this.messages.length-1].id)return null;return i=n(this.messages,u,function(t,e){return t.id.localeCompare(e.id)}),i>=0?(u=this.messages[i],e>=0?u._update(t)&&this.emit("message",u,0):(this.messages.splice(i,1),this.emit("message",u,-1))):(i=~i,o(this.messages,u,i),this.emit("message",u,1)),u},e.prototype.add=function(t,e){var n;return n={id:t,conversation:this.id},this._rpc("chat.participant.add",n,function(t){return function(n,o){var r;return n?"function"==typeof e?e(n):void 0:o.id?(r=t._addParticipant(o),"function"==typeof e?e(null,r):void 0):"function"==typeof e?e("Missing participant id"):void 0}}(this))},e.prototype.kick=function(t,e){var n,o;return n=this.participants[t],console.log("Found to kick",n),n?(this._removeParticipant(n),o={id:t,conversation:this.id},this._rpc("chat.participant.kick",o,function(t){return function(t,n){return"function"==typeof e?e(t):void 0}}())):"function"==typeof e?e("No participant"):void 0},e.prototype.fetchParticipants=function(){var t;return t={conversation:this.id},this._rpc("chat.participant.list",t,function(t){return function(e,n){if(!e)return t._applyParticipants(n,!0)}}(this))},e.prototype._applyParticipants=function(t,e){var n,o,r,i,s,u,a,c;for(c=null,i=this.participants,e&&(c=Object.assign({},this.participants),i={}),r=0,o=t.length;r<o;r++)s=t[r],this.me.id!==s.id?(u=this.participants[s.id],u?(i[s.id]=u,e&&delete c[s.id],u._update(s)&&(this.emit("participant",u,0),u.emit("change"))):(u=this._addParticipant(s),i[s.id]=u)):this.me._update(s)&&this.me.emit("change");if(e){this.participants=i,a=[];for(n in c)u=c[n],a.push(this._removeParticipant(u));return a}},e.prototype._applyParticipant=function(t,e){var n;if(this.me.id===t.id)return void(this.me._update(t)&&this.me.emit("change"));if(n=this.participants[t.id]){if(e<0)return this._removeParticipant(n);if(n._update(t))return this.emit("participant",n,0),n.emit("change")}else if(e>=0)return this._addParticipant(t)},e.prototype._addParticipant=function(t){var e;return e=new a(this,t),this.participants[e.id]=e,this.emit("participant",e,1),e},e.prototype._removeParticipant=function(t){return delete this.participants[t.id],this.emit("participant",t,-1),t},e.prototype._sendUpdateMe=function(t){var e,n;return e=this.me,n={role:e.role,seen:e.seen,seenId:e.seenId,state:e.state,id:"me",conversation:this.id},this._rpc("chat.participant.update",n,function(e,n){return console.log("me.update sent",e,n),"function"==typeof t?t(e):void 0})},e.prototype._handleRemoteSignal=function(t,e){var n,o,r;switch(t.type){case"typing":if(n=null!=(r=t.data)&&r,console.log("Got typing",n,"from",e,"in",this.id),!(o=this.participants[e]))return;if(n){if(this._startedTyping[e]=Date.now(),o.typing)return}else if(delete this._startedTyping[e],!o.typing)return;return o.typing=n,o.emit("typing",o.typing)}},e.prototype._expireTyping=function(){var t,e,n,o,r,i,s;o=Date.now(),s=[],r=this._startedTyping;for(t in r)r[t]+9e3>o||s.push(t);for(i=[],n=0,e=s.length;n<e;n++)t=s[n],i.push(this._stopTyping(t));return i},e.prototype._stopTyping=function(t){var e;if(delete this._startedTyping[t],e=this.participants[t])return e.typing=!1,e.emit("typing",e.typing)},e.prototype._rpc=function(t,e,n){return this.chat.signal.conn.rpc(t,e,n)},n=function(t,e,n){var o,r,i,s;for(i=0,r=t.length-1,s=0,o=0;i<=r;)if(s=i+r>>1,(o=n(t[s],e))<0)i=s+1;else{if(!(o>0))return s;r=s-1}return~i},o=function(t,e,n){var o,r,i,s;for(i=e,s=e,o=t.length,r=[];n<=o;)s=t[n],t[n]=i,i=s,r.push(n++);return r},e}(r),t.exports=o},function(t,e,n){var o,r,i=function(t,e){function n(){this.constructor=t}for(var o in e)s.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;o=n(0),r=function(t){function e(t,n){this.id=n,e.__super__.constructor.apply(this,arguments),this.role="user",this.state=null,this.seen=0,this.seenId=null,this.typing=!1,this._lastTypingSent=0,this.sendTyping=function(e){return function(n){var o,r,i;if(!((r=Date.now())-e._lastTypingSent<7e3&&n===e.typing))return e.typing=n,e._lastTypingSent=r,o="_c."+t.id,null!=(i=t.chat.signal.channels[o])?i.publish({type:"typing",data:n}):void 0}}(this)}return i(e,t),e.prototype._update=function(t){var e,n,o,r,i;for(e=!1,i=["role","seen","seenId","state"],n=0,r=i.length;n<r;n++)o=i[n],this[o]!==t[o]&&(this[o]=t[o],e=!0);return e},e.prototype.updateState=function(t){return this.state!==t&&(this.state=t,this.emit("stateSet"),!0)},e.prototype.updateSeen=function(t,e){var n,o;return!!t&&(null==t.sending&&(n=null!=(o=t.id)?o:t,this.seenId!==n&&(this.seenId=n,null==e&&(e=Date.now()),t.created>e&&(e=t.created),this.seen=e,this.emit("seenSet"),!0)))},e}(o),t.exports=r},function(t,e){var n;n=function(){function t(t){var e,n;this.id=null,this.from=null,this.text=null,this.data=null,this.created=0;for(e in t)n=t[e],this[e]=n}return t.prototype._update=function(t){var e,n,o,r,i;for(e=!1,i=["text","data","sending","failed","progress","total"],n=0,r=i.length;n<r;n++)o=i[n],this[o]!==t[o]&&(this[o]=t[o],e=!0);return e},t}(),t.exports=n},function(t,e,n){var o,r,i;r=n(5),o=function(){function t(e){this.conv=e,this.m={id:t._uniqueId(),created:Date.now(),from:this.conv.me.id,text:null,data:null,sending:!1,failed:!0}}var e,n,o;return t.prototype._export=function(){var t,e,n,o,r;for(r={},o=["text","data"],t=0,n=o.length;t<n;t++)e=o[t],this.m[e]&&(r[e]=this.m[e]);return r},t.prototype.hasAttachment=function(){return null!=this.attachFile},t.prototype.text=function(t){return this.m.text=t,this},t.prototype.attach=function(t){return this.attachFile=t,this.m.progress=0,this.m.total=-1,this},t.prototype.send=function(t){return this.m.sending=!0,this.m.failed=!1,this.hasAttachment()?this._loadAttachmentAndThumbnail(function(e){return function(n){return e.conv._applyMessage(e.m,1),n?e._fail(n,t):e._getUploadParams(function(n,o){return n?e._fail(n,t):e._uploadAttachmentAndThumbnail(o,function(n){return n?e._fail(n,t):e._send2(t)})})}}(this)):(this.conv._applyMessage(this.m,1),void this._send2(t))},t.prototype._send2=function(t){return"::_fail"===this.m.text?void setTimeout(function(e){return function(){return e._fail("big error",t)}}(this),1e3):this.conv.send(this._export(),function(e){return function(n,o){return console.log("Outgoing.send2 done",n,o),n?e._fail(n,t):(e.conv._applyMessage(e.m,-1),"function"==typeof t?t(null,o):void 0)}}(this))},t.prototype._fail=function(t,e){return this.m.sending=!1,this.m.failed=!0,console.log("Failed message",this),this.conv._applyMessage(this.m,0),"function"==typeof e?e(t):void 0},t.prototype._getUploadParams=function(t){var e,n;return null==(null!=(e=this.m.data)?e.type:void 0)?t("Attachment type is not specified",null):this.conv.chat._prepareAttachment(this.m.data.type,null!=(n=this.thumbBlob)?n.type:void 0,t)},t.prototype._loadAttachmentAndThumbnail=function(t){return r.readFileAsArrayBuffer(this.attachFile,function(e){return function(n,o,r){return n&&console.log("Read file ",o,"err=",n),null!=n?t(n):e._handleAttachmentFileLoaded(o,r,t)}}(this))},t.prototype._uploadAttachmentAndThumbnail=function(e,n){var o,r,i;return o=this.attachFile,r=0,i=e.uploads.attach,t.uploadFile(i.endpoint,i.params,o,function(o){return function(s){return s&&console.log("Main attach uploaded err=",s),null!=s?n(s):(o.m.data.attach=e.urls.attach,null==o.m.data.thumb||null==o.thumbBlob?n(null):(i=e.uploads.thumb,t.uploadFile(i.endpoint,i.params,o.thumbBlob,function(t){return t&&console.log("Thumb uploaded err=",t),null!=t?n(t):(o.m.data.thumb=e.urls.thumb,n(null))},function(t,e){return o.m.progress=t+r,o.m.total=e+r,o.conv._applyMessage(o.m,0)})))}}(this),function(t){return function(e,n){return r=e,t.m.progress=e,t.m.total=n,t.conv._applyMessage(t.m,0)}}(this))},t.prototype._handleAttachmentFileLoaded=function(t,e,n){var o,r,i,s,u,a,c,l;return l=null!=(a=null!=t?t.type:void 0)?a:"",i=0===l.indexOf("image/"),s=0===l.indexOf("video/"),r=0===l.indexOf("audio/"),i||s?(o=new Blob([e],t),c=(window.URL||window.webkitURL).createObjectURL(o),u=null,i?(u=new Image,u.onload=function(e){return function(){return e._attachmentMediaLoaded(u,t,n)}}(this)):(u=document.createElement("video"),u.setAttribute("preload",""),u.setAttribute("muted",""),u.onloadedmetadata=function(t){return function(){return console.log("Video meta loaded",u.videoWidth,u.videoHeight,u.duration)}}(),u.onloadeddata=function(e){return function(){return console.log("Video loaded",u),e._attachmentMediaLoaded(u,t,n)}}(this),u.onerror=function(e){return function(){return console.log("Error on video loading. Still can send the file"),e._attachmentMediaLoaded(u,t,n)}}(this)),u.src=c):r?(this.m.data={type:t.type},n(null)):n("Cannot handle files with type"+l)},t.prototype._attachmentMediaLoaded=function(e,n,o){return(window.URL||window.webkitURL).revokeObjectURL(e.src),t.createThumbnail(e,function(t){return function(e,i){return e&&console.log("Thumb created err=",e),null!=e?o(e):(null!=i&&(t.thumbBlob=r.dataUrlToBlob(i)),t.m.data={type:n.type,attach:i,thumb:i},o(null))}}(this))},o=Math.floor(65535*Math.random()),n=Math.floor(16777215*Math.random()),e=0,t._uniqueId=function(){var t,r,i,s,u;return e=e+1&16777215,u=Math.floor(Date.now()/1e3),s=u.toString(16),s="00000000".substr(0,8-s.length)+s,r=n.toString(16),r="000000".substr(0,6-r.length)+r,i=o.toString(16),i="0000".substr(0,4-i.length)+i,t=e.toString(16),t="000000".substr(0,6-t.length)+t,s+r+i+t},t.createThumbnail=function(t,e){var n,o,r,i,s,u,a,c,l,p;return s=320,i=320,p=null!=(u=null!=t?t.videoWidth:void 0)?u:t.width,l=null!=(a=null!=t?t.videoHeight:void 0)?a:t.height,p>l?p>s&&(l*=s/p,p=s):l>i&&(p*=i/l,l=i),n=document.createElement("canvas"),n.width=p,n.height=l,o=n.getContext("2d"),o.drawImage(t,0,0,p,l),r=n.toDataURL("image/jpeg"),(null!=(c=r.split(":")[1])?c.length:void 0)<2&&(r=null),e(null,r)},t.uploadFile=function(e,n,o,r,s){var u;return u=new i(n,o),u.build(function(n,o,i){return null!=n?r(n):t._upload(e,o,i,r,s)})},t._upload=function(t,e,n,o,r){var i,s,u;return u=new XMLHttpRequest,u.open("POST",t,!0),u.onload=function(t){return o(u.status>=200&&u.status<300?null:{status:u.status,text:u.statusText,info:u.responseText})},u.onerror=function(t){return console.log("xhr error",t),o(t)},u.onabort=function(t){return console.log("xhr cancel"),o(t)},u.onprogress=function(t){return console.log("xhr progress",t)},s=null!=(i=null!=u?u.upload:void 0)?i:null,s&&(s.onload=function(t){return console.log("xhr upload complete",t)},s.onerror=function(t){return console.log("xhr upload error",t)},s.onabort=function(t){return console.log("xhr upload cancel",t)},s.onprogress=function(t){var e;return e=t.lengthComputable?t.total:-1,"function"==typeof r?r(t.loaded,e):void 0}),null!=n&&u.setRequestHeader("Content-Type",n),u.send(e)},t}(),i=function(){function t(t,e){if(!this._needsFormDataShim())return this._createFormData(t,e);this._initMultiPart(t,e)}return t.prototype._createFormData=function(t,e){var n,o;this.fd=new FormData;for(n in t)o=t[n],this.fd.append(n,o);return this.fd.append("file",e)},t.prototype._initMultiPart=function(t,e){var n,o;this.boundary=Array(21).join("-")+(+new Date*(1e16*Math.random())).toString(36),this.parts=[];for(n in t)o=t[n],this._append(n,o);return e instanceof File?this.fileToLoad=e:this._append("file",e)},t.prototype._append=function(t,e,n){return this.parts.push("--"+this.boundary+'\r\nContent-Disposition: form-data; name="'+t+'"'),e instanceof Blob&&(null==n&&(n="blob"),this.parts.push('; filename="'+n+'"\r\nContent-Type: '+e.type)),this.parts.push("\r\n\r\n"),this.parts.push(e),this.parts.push("\r\n")},t.prototype.build=function(t){return null!=this.fd?t(null,this.fd):this._ensureFileLoaded("file",this.fileToLoad,function(e){return function(n){return n?t(n):e._completeMultiPart(t)}}(this))},t.prototype._ensureFileLoaded=function(t,e,n){return null==e?n(null):r.readFileAsArrayBuffer(e,function(e){return function(o,r,i){return o?n(o):(e._append(t,new Blob([i],{type:r.type},r.name)),n(null))}}(this))},t.prototype._completeMultiPart=function(t){var e,n;return this.parts.push("--"+this.boundary+"--"),e=new Blob(this.parts),n=new FileReader,n.onload=function(e){return function(){return t(null,n.result,"multipart/form-data; boundary="+e.boundary)}}(this),n.onerror=function(e){return t(e)},n.readAsArrayBuffer(e)},t.prototype._needsFormDataShim=function(){var t,e;return t=navigator.userAgent,e=navigator.vendor,~t.indexOf("Android")&&~e.indexOf("Google")&&!~t.indexOf("Chrome")&&t.match(/AppleWebKit\/(\d+)/).pop()<=534},t}(),t.exports=o},function(t,e,n){var o,r,i=function(t,e){function n(){this.constructor=t}for(var o in e)s.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;o=n(0),r=function(t){function e(t,n){var o,r;e.__super__.constructor.apply(this,arguments),this.id=null,this.role="user",this.state=null,this.seen=0,this.seenId=null,this.typing=!1;for(o in n)r=n[o],this[o]=r;this.kick=function(e){return function(n){return t.kick(e.id,n)}}(this)}return i(e,t),e.prototype._update=function(t){var e,n,o,r,i;for(e=!1,i=["role","seen","seenId","state"],n=0,r=i.length;n<r;n++)o=i[n],this[o]!==t[o]&&(this[o]=t[o],e=!0);return e},e}(o),t.exports=r},function(t,e,n){var o,r,i,s,u=function(t,e){function n(){this.constructor=t}for(var o in e)a.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},a={}.hasOwnProperty;o=n(0),r=n(18),s=n(19),i=function(t){function e(t){this.signal=t,e.__super__.constructor.apply(this,arguments),this.outgoing={},this.incoming={},this.signal.conn.addHandler("invite",this._handleRpcNotify.bind(this),null)}return u(e,t),e.prototype.destroy=function(){},e.prototype.send=function(t,e){return console.log("Send invite",t),this.signal.conn.rpc("invite.invite.send",t,function(t){return function(n,o){var r;return console.log("invite.send resp",n,o),n||(null!=o?o.id:void 0)||(n="Cannot send invite"),n?e(n):(r=new s(t,o),t.outgoing[r.id]=r,e(null,r))}}(this))},e.prototype.fromPush=function(t,e){var n,o,i,s;return(null!=t&&null!=(i=t._invite)?i.id:void 0)?(console.log("Extracting Invite from Push payload",t),o=Object.assign({},t._invite),o.from=t.sender,o.payload=null!=(s=t.invite)?s:{},n=this.incoming[o.id],n||(n=new r(this,o),!0===n.timeout&&(n.active=!1),this.incoming[n.id]=n,!1===e&&this.emit("invite",n)),n.timeout&&(delete this.incoming[o.id],n.active=!1,setTimeout(function(){return n.emit("timeout",o.payload)},1)),n):null},e.prototype._handleRpcNotify=function(t,e){var n,o,i,s,u,a;switch(console.log("Invite.handleRpcNotify",t,e),t){case"invite.timeout":if(i=e.id,u=this.outgoing[i])return delete this.outgoing[i],u.emit("timeout");if(u=this.incoming[i])return delete this.incoming[i],u.active=!1,u.emit("timeout",e.payload);break;case"invite.receive":return u=new r(this,e),this.incoming[u.id]=u,this.emit("invite",u);case"invite.handled":if(i=e.id,o=e.from,n=o.split("/"),a=this.signal.accessToken,!((null!=n?n[0]:void 0)===a.identity&&(null!=n?n[1]:void 0)===a.device))return(u=this.incoming[i])?(delete this.incoming[i],u.active=!1,u.emit("handled")):void console.log("Unknown incoming invite",e);break;case"invite.replied":return i=e.id,(u=this.outgoing[i])?(delete this.outgoing[i],s=e.accepted?"accept":"reject",u.emit(s,e.payload)):void console.log("Unknown outgoing invite",e)}},e}(o),t.exports=i},function(t,e,n){var o,r,i=function(t,e){function n(){this.constructor=t}for(var o in e)s.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;o=n(0),r=function(t){function e(t,n){this._svc=t,e.__super__.constructor.apply(this,arguments),Object.assign(this,n),this.active=!0}return i(e,t),e.prototype.accept=function(t,e){return this.reply(!0,t,e)},e.prototype.reject=function(t,e){return this.reply(!1,t,e)},e.prototype.reply=function(t,e,n){var o,r;return o=this.id,console.log("Reply to incoming invite accepted=",t,o),delete this._svc.incoming[o],r={id:o,accepted:t,payload:e,route:o.split(".")[1]},this._svc.signal.conn.rpc("invite.invite.reply",r,function(t,e){return console.log("Replied to incoming invite",r,t,e),"function"==typeof n?n(t):void 0})},e}(o),t.exports=r},function(t,e,n){var o,r,i=function(t,e){function n(){this.constructor=t}for(var o in e)s.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;o=n(0),r=function(t){function e(t,n){this._svc=t,e.__super__.constructor.apply(this,arguments),Object.assign(this,n)}return i(e,t),e.prototype.cancel=function(t){var e,n;return e=this.id,console.log("Cancel outgoing invite",e),delete this._svc.outgoing[e],this.emit("cancel"),n={id:e,route:e.split(".")[1]},this._svc.signal.conn.rpc("invite.invite.cancel",n,function(n,o){return console.log("Canceled outgoing invite",e,n,o),"function"==typeof t?t(n):void 0})},e}(o),t.exports=r},function(t,e,n){var o,r;r=n(4),o=function(){function t(t){this.accessToken=t}return t.prototype.destroy=function(){},t.prototype.register=function(t,e){return this._api("post","/devices",null,t,e)},t.prototype.unregister=function(t){return this._api("post","/devices",null,null,t)},t.prototype.send=function(t,e){return this._api("post","/messages",null,t,e)},t.prototype._api=function(t,e,n,o,i){var s,u;return s=this.accessToken.claims.aud+"/push/v1",u={json:!0,method:t,url:s+e,headers:{authorization:"bearer "+this.accessToken.token}},n&&(u.qs=n),o&&(u.form=o),r(u,i)},t}(),t.exports=o},function(t,e,n){var o,r,i,s,u=function(t,e){function n(){this.constructor=t}for(var o in e)a.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},a={}.hasOwnProperty;r=n(0),s=n(6),o=n(22),i=function(t){function e(t){this.accessToken=t,e.__super__.constructor.apply(this,arguments),this.channels={},this.conn=new s,this._updateWsRpc(),this.accessToken.on("updated",function(t){return function(){return t._updateWsRpc()}}(this)),this.conn.addHandler("signal",this._handleRpcNotify.bind(this),null),this.conn.on("open",function(t){return function(){return t.emit("connect")}}(this)),this.conn.on("close",function(t){return function(){var e,n,o;n=t.channels,t.channels={};for(o in n)e=n[o],t.emit("channel",e,-1);return t.emit("disconnect")}}(this)),setTimeout(function(t){return function(){return t.conn.connect()}}(this),0)}return u(e,t),e.prototype.destroy=function(){var t;return null!=(t=this.conn)?t.disconnect():void 0},e.prototype._updateWsRpc=function(){var t;return t=this.accessToken.claims.aud,t.indexOf("v1")>0?t+="/signal/pubsub":t+="/signal/v1/pubsub",0===t.indexOf("http")&&(t="ws"+t.substring(4)),t+="?jwt="+this.accessToken.token,this.conn.update({url:t})},e.prototype._handleRpcNotify=function(t,e){var n;if(null!=(null!=e?e.id:void 0))return void(null!=(n=this.channels[null!=e?e.id:void 0])&&n._handleRpcNotify(t,e));switch(t){case"send":return this.emit("message",e)}},e.prototype.send=function(t){return null!=(null!=t?t.to:void 0)&&(this.rpc("send",t),!0)},e.prototype.join=function(t,e){var n,r,i,s,u;if(!t)return null;if(null!=(n=this.channels[t]))return n;if(s=this.accessToken.claims.sub,n=new o(this,t,e,s),this.channels[t]=n,r={id:t},e&&null!=e)for(i in e)u=e[i],r[i]=u;return this.rpc("join",r),this.emit("channel",n,1),n},e.prototype._leave=function(t){var e;return null!=(null!=t?t.id:void 0)&&(t=t.id),e=this.channels[t],e&&(delete this.channels[t],this.rpc("leave",{id:t}),this.emit("channel",e,-1)),e},e.prototype.rpc=function(t,e){return this.conn.rpc("signal."+t,e)},e}(r),t.exports=i},function(t,e,n){var o,r,i,s,u=function(t,e){function n(){this.constructor=t}for(var o in e)a.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},a={}.hasOwnProperty;r=n(0),i=n(23),s=n(24),o=function(t){function e(t,o,r,s){var u,a;this.signal=t,this.id=o,this.options=r,e.__super__.constructor.apply(this,arguments),null==this.options&&(this.options={}),null==(u=this.options).presence&&(u.presence=!1),a=s.split(n)[0],this.me=new i(this,s,a),this.participants={}}var n;return u(e,t),n="/",e.prototype._handleRpcNotify=function(t,e){var o,r,i,u,a,c;switch(o=null!=e?e.from:void 0,u=null!=(a=this.participants)?a[o]:void 0,t){case"publish":case"send":return e.state?u?(u.state=e.state,u.emit("state",u.state)):console.log("Error - got state update for unknown participant",t,e):u?u.emit("message",e):this.emit("message",e);case"join":case"join_back":if(console.log("Channel join from remote",e),i=0,u||(i=1,r=null!=o&&null!=(c=o.split(n))?c[0]:void 0,u=new s(this,o,r),this.participants[o]=u),this.emit("participant",u,i),this.me.state)return u.send({state:this.me.state});break;case"leave":if(console.log("Channel leave from remote",e),u)return delete this.participants[o],this.emit("participant",u,-1)}},e.prototype.leave=function(){return this.signal._leave(this.id)},e.prototype.publish=function(t){return t.id=this.id,this.signal.rpc("publish",t)},e}(r),t.exports=o},function(t,e,n){var o,r,i=function(t,e){function n(){this.constructor=t}for(var o in e)s.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;o=n(0),r=function(t){function e(t,n,o){this.channel=t,this.id=n,this.identity=o,e.__super__.constructor.apply(this,arguments),this.state=null}return i(e,t),e.prototype.updateState=function(t){if(t!==this.state)return this.state=t,this.channel.signal.rpc("publish",{id:this.channel.id,state:this.state}),this.emit("state",this.state),console.log("Update my state",this.id,this.state)},e}(o),t.exports=r},function(t,e,n){var o,r,i=function(t,e){function n(){this.constructor=t}for(var o in e)s.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;o=n(0),r=function(t){function e(t,n,o){this.channel=t,this.id=n,this.identity=o,e.__super__.constructor.apply(this,arguments)}return i(e,t),e.prototype.send=function(t){return t.to=this.id,t.id=this.channel.id,this.channel.signal.rpc("send",t)},e}(o),t.exports=r},function(t,e,n){var o,r,i,s,u,a=function(t,e){function n(){this.constructor=t}for(var o in e)c.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},c={}.hasOwnProperty;o=n(0),r=n(26),i=n(27),s=n(30),u=function(t){function e(t){this.signal=t,e.__super__.constructor.apply(this,arguments),this.sessions={},this.capture=new r,this.signal.on("channel",function(t){return function(e,n){var o;if(!(!n<0))return o=t._deleteSession(e.id),null!=o?o._destroy():void 0}}(this)),this.signal.conn.addHandler("video",this._handleRpcNotify.bind(this),null),this.verto=new s,this.verto.on("session",function(t){return function(e,n){if(!(!n<0))return t._deleteSession(e.id)}}(this)),this.iceServers=[{url:"stun:stun.l.google.com:19302"}],this._requestIceServers()}var n,o;return a(e,t),n=3600,o=function(t){var e,n;for(e=0,n=t.length;e<n;e++)return t[e],!1;return!0},e.prototype.destroy=function(){return this.iceTimer&&clearTimeout(this.iceTimer),this.iceTimer=null,this.verto.destroy()},e.prototype._deleteSession=function(t){var e;return null!=t.id&&(t=t.id),(e=this.sessions[t])?(delete this.sessions[e.id],this.emit("session",e,-1),o(this.sessions)&&this.capture.stop(),e):null},e.prototype._requestIceServers=function(){return this.signal.conn.rpc("video.ice.get",{ttl:n},function(t){return function(e,o){var r,i,s;if(console.log("video.ice.get response",e,o),null!=o?o.iceServers:void 0){t.iceServers=o.iceServers,i=t.sessions;for(r in i)s=i[r],s.options.iceServers=t.iceServers;return setTimeout(function(){return t._requestIceServers()},1e3*(n-30))}}}(this))},e.prototype.getIceServers=function(){return this.iceServers},e.prototype.create=function(t,e){return this.signal.conn.rpc("video.session.create",t,function(t){return function(n,o){return console.log("video.session.create response",n,o),n?"function"==typeof e?e(n):void 0:(null!=o?o.id:void 0)?t._setup(o.id,o,e):"function"==typeof e?e("Cannot create session"):void 0}}(this))},e.prototype.join=function(t,e){return this.signal.conn.rpc("video.session.join",{id:t},function(t){return function(n,o){return console.log("video.session.join response",n,o),n?"function"==typeof e?e(n):void 0:(null!=o?o.id:void 0)?t._setup(o.id,o,e):"function"==typeof e?e("Cannot join session"):void 0}}(this))},e.prototype._setup=function(t,e,n){var o,r;return r=this.sessions[t],null!=r?"function"==typeof n?n(null,r):void 0:e.connection?(console.log("Need to connect",e),this.verto.createSession(e,function(t){return function(e,o){return e?"function"==typeof n?n(e):void 0:t._setupDone(o,n)}}(this))):(o=this.signal.join(t,{presence:!0}),r=new i(t,e,o),this._setupDone(r,n))},e.prototype._setupDone=function(t,e){return t._init(this.capture,this.getIceServers.bind(this)),this.sessions[t.id]=t,this.emit("session",t,1),"function"==typeof e?e(null,t):void 0},e.prototype._handleRpcNotify=function(t,e){var n,o,r,i;switch(console.log("Video.handleRpcNotify",t,e),t){case"publish":return null!=(n=this.sessions[e.id])&&null!=(o=n.rtc)?o.gotRemoteOfferAnswer(e.data):void 0;case"subscribe":return null!=(r=this.sessions[e.id])&&null!=(i=r.participants[e.from])?i._subscribeFromSfu(e.data):void 0}},e}(o),t.exports=u},function(t,e,n){var o,r,i,s=function(t,e){function n(){this.constructor=t}for(var o in e)u.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},u={}.hasOwnProperty;o=n(0),r=n(2),i=function(t){function e(){e.__super__.constructor.apply(this,arguments),this.options={audio:!1,video:!1,screen:!1},this.preparingScreen=!1,this.preparingMedia=!1,this.errorScreen=null,this.errorMedia=null,this.cbs=[],this.localStream=null,this.localEl=null,this.localScreenStream=null}return s(e,t),e.prototype.getStreams=function(t){var e;return e=[],(t.audio||t.video)&&this.localStream&&e.push(this.localStream),t.screen&&this.localScreenStream&&e.push(this.localScreenStream),e},e.prototype.request=function(t,e){return this._prepareScreenSharing(null!=t?t.screen:void 0,function(n){return function(o){var r,i,s,u;return o&&console.log("RtcCapture.request: Could not get ScreenSharing",o),r=null!=(s=t.audio)?s:n.options.audio,i=null!=(u=t.video)?u:n.options.video,n._prepareCameraMic(r,i,function(t){return t&&console.log("RtcCapture.request: Could not get audio/video",t),n._check(e)})}}(this))},e.prototype._check=function(t){var e,n,o,r,i,s;if(this.preparingScreen||this.preparingMedia)return void this.cbs.push(t);if(n=this.errorMedia,n||this.localStream||(n=this.errorScreen),t(n),this.cbs.length>0){for(s=this.cbs,this.cbs=[],i=[],o=0,r=s.length;o<r;o++)e=s[o],i.push(e(n));return i}},e.prototype.stop=function(){var t;return this.localScreenStream&&(r.stopMediaStream(this.localScreenStream),this.localScreenStream=null),this.localStream&&(r.stopMediaStream(this.localStream),this.localStream=null),this.localEl&&(t=this.localEl,this.localEl=null,null!=t.src&&(t.src=""),this.emit("video",t,-1)),this.options={audio:!1,video:!1,screen:!1}},e.prototype._getScreenSharingOpts=function(t){var e,n;return null!=("undefined"!=typeof navigator&&null!==navigator?navigator.mozGetUserMedia:void 0)?(n={video:{mozMediaSource:"window",mediaSource:"window"}},t(null,n)):(e=function(o){var r;if(r=null!=o?o.data:void 0,console.log("WebApp.gotMessage",r),"completed"===(null!=r?r.state:void 0))return console.log("WebRTC onmsg done"),window.removeEventListener("message",e,!1),n={audio:!1,video:{mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:o.data.streamId,maxWidth:window.screen.width,maxHeight:window.screen.height}}},t(null,n)},window.addEventListener("message",e,!1),window.postMessage({requestId:100,data:["screen","window"]},"*"))},e.prototype._prepareScreenSharing=function(t,n){return!1===t&&this.localScreenStream?(this.localScreenStream=null,n(null)):!0==!t?n(null):(this.options.screen=!0,this.localScreenStream?n(null):this.preparingScreen?n(null):(this.preparingScreen=!0,this._getScreenSharingOpts(function(t){return function(o,r){return null!=o?(t.preparingScreen=!1,t.errorScreen=o,n(o)):e.getUserMedia(r,function(e,o){return t.preparingScreen=!1,null!=e&&(t.errorScreen=e),null==e&&(t.localScreenStream=o),n(e)})}}(this))))},e.prototype._prepareCameraMic=function(t,n,o){var r;return this.options.audio===t&&this.options.video===n?o(null):this.preparingMedia?o(null):t||n?(this.options.audio=t,this.options.video=n,r={audio:this.options.audio,video:this.options.video},this.preparingMedia=!0,e.getUserMedia(r,function(t){return function(e,n){return t.preparingMedia=!1,null!=e&&(t.errorMedia=e),t._handleLocalCameraMicStream(n),o(e)}}(this))):(this.options.audio=this.options.video=!1,this._handleLocalCameraMicStream(null),o(null))},e.prototype._handleLocalCameraMicStream=function(t){var e,n,o;return n=this.localStream,this.localStream=t,n&&n!==t&&r.stopMediaStream(n),e=null!=(o=this.localEl)?o:null,this.options.video&&t!==n?(e||(e="undefined"!=typeof document&&null!==document?document.createElement("video"):void 0,null!=e&&e.setAttribute("autoplay","true"),null!=e&&e.setAttribute("muted","true"),null!=e&&(e.muted=!0),null==e&&(e={srcObject:t}),this.emit("video",e,1)),this.localEl=r.attachMediaStream(e,t)):this.options.video||null==e?void 0:(this.localEl=null,e.src="",this.emit("video",e,-1))},e.getUserMedia=function(t,e){var n,o,r,i,s;return s=window,o=navigator,n=null,!n&&(null!=s?s.getUserMedia:void 0)&&(n=s.getUserMedia.bind(s)),!n&&o&&(n=null!=(r=null!=(i=o.getUserMedia)?i:o.mozGetUserMedia)?r:o.webkitGetUserMedia)&&(n=n.bind(o)),null==n?e("WebRTC not supported. Could not find getUserMedia()"):n(t,function(t){return e(null,t)},e)},e}(o),t.exports=i},function(t,e,n){var o,r,i,s,u,a,c=function(t,e){function n(){this.constructor=t}for(var o in e)l.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},l={}.hasOwnProperty;o=n(0),a=n(1),r=n(28),i=n(29),s=n(2),u=function(t){function e(t,n,o){var r;this.id=t,this.options=n,this.channel=o,e.__super__.constructor.apply(this,arguments),null==this.options&&(this.options={}),null==(r=this.options).mode&&(r.mode="p2p"),this.participants={},this.rtc=null}return c(e,t),e.prototype._init=function(t,e){return this.getIceServers=e,this.me=new r(this.channel.me,t),this.me.on("change",function(t){return function(){var e,n,o,r;"sfu"===t.options.mode&&t._updateForSfu(t.me.pub),o=t.participants,r=[];for(e in o)n=o[e],r.push(n._update());return r}}(this)),this.channel.on("participant",function(t){return function(e,n){var o;return console.log("Session participant",n,e),o=t.participants[e.id],n>0?(o=new i(e,t),t.participants[e.id]=o,o.on("video",function(e,n){return t.emit("video",e,o,n)}),t.emit("participant",o,n)):n<0?o?(delete t.participants[e.id],o._destroy(),t.emit("participant",o,n)):console.log("Error - cannot find Video Session Participant for",e):void 0}}(this))},e.prototype._destroy=function(){var t,e,n;e=this.participants;for(t in e)n=e[t],n._destroy();return this.participants={}},e.prototype.leave=function(){return this.channel.leave()},e.prototype._updateForSfu=function(t){var e,n,o,r,i,u,c,l,p,h;for(u=!1,i=!1,c=null!=(l=this.rtc)?l.sendOpts:void 0,p=a.MEDIA_KINDS,n=0,r=p.length;n<r;n++)o=p[n],!0===t[o]&&(u=!0),t[o]!==(null!=c?c[o]:void 0)&&(i=!0);if((u||i)&&this.rtc&&(this.rtc.stop(),this.rtc=null,i=!0),u?this.rtc||(i=!0,e={getLocalStreams:function(t){return function(e){return t.me.capture.getStreams(e)}}(this),getIceServers:this.getIceServers},this.rtc=new s,this.rtc.init(!0,e),this.rtc.on("offerAnswer",function(e){return function(n){return e._sendToSfu("publish",{data:n,pub:t})}}(this)),this.rtc.on("icecandidate",function(t){return function(e){return t._sendToSfu("trickle",{data:e})}}(this))):this.rtc&&(null!=(h=this.rtc)&&h.stop(),this.rtc=null),i)return this.rtc?this.rtc.update(t,{}):this._sendToSfu("publish",{pub:t})},e.prototype._sendToSfu=function(t,e){return e.id=this.id,this.channel.signal.conn.rpc("video.session."+t,e)},e}(o),t.exports=u},function(t,e,n){var o,r,i,s=function(t,e){function n(){this.constructor=t}for(var o in e)u.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},u={}.hasOwnProperty;o=n(0),i=n(1),r=function(t){function e(t,n){this.signal=t,this.capture=n,e.__super__.constructor.apply(this,arguments),this.id=this.signal.id,this.pub={}}return s(e,t),e.prototype.publish=function(t){var e,n,o,r,s,u;for(t=null!=t?t:{},r=i.MEDIA_KINDS,e=0,o=r.length;e<o;e++)n=r[e],null==t[n]&&(t[n]=null!=(s=null!=(u=this.pub)?u[n]:void 0)&&s);return this.capture.request(t,function(e){return function(o){var r,i,s;for(o&&(console.log("Error getting local media",o),e.emit("error","Unable to get local media")),s=["audio","video","screen"],r=0,i=s.length;r<i;r++)n=s[r],t[n]=e.capture.options[n]&&!1!==t[n];return e.pub=t,e.signal.updateState({pub:e.pub}),e.emit("change")}}(this))},e}(o),t.exports=r},function(t,e,n){var o,r,i,s,u=function(t,e){function n(){this.constructor=t}for(var o in e)a.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},a={}.hasOwnProperty;o=n(0),s=n(1),i=n(2),r=function(t){function e(t,o){this.signal=t,this.session=o,e.__super__.constructor.apply(this,arguments),this.id=this.signal.id,this.pub={},this.sub={},this.subTo={},this.dirs={},this.rtc=null,this.signal.on("state",function(t){return function(e){return console.log("Got remote state",t.id,e),t.pub=n(t.pub,null!=e?e.pub:void 0),console.log(" - updated remote state",t.pub),t._update()}}(this)),this.signal.on("message",function(t){return function(e){switch(e.type){case"subscribe":return t.sub=n(t.sub,e.data),t._update();case"offerAnswer":return t.rtc?t.rtc.gotRemoteOfferAnswer(e.data):(console.log("Warning - no RTC to handle signal",e,t),t._pendingOfferAnswer=e.data);case"icecandidate":return t.rtc?t.rtc.gotRemoteIceCandidate(e.data):(console.log("Warning - no RTC to handle signal",e,t),null==t._pendingIceCandidates&&(t._pendingIceCandidates=[]),t._pendingIceCandidates.push(e.data))}}}(this))}var n;return u(e,t),n=function(t,e){var n,o,r,i,u,a;for(i=s.MEDIA_KINDS,n=0,r=i.length;n<r;n++)o=i[n],t[o]=null!=(u=null!=(a=null!=e?e[o]:void 0)?a:t[o])&&u;return t},e.prototype._destroy=function(){var t;return delete this._pendingOfferAnswer,delete this._pendingIceCandidates,null!=(t=this.rtc)&&t.stop(),this.rtc=null},e.prototype.subscribe=function(t){return this.subTo=n(this.subTo,t),console.log("Subscribe to remote",this.subTo,t),this.signal.send({type:"subscribe",data:this.subTo}),this._update()},e.prototype._update=function(){var t,e,n,o,r,i,u,a,c,l,p,h;for(c="p2p"===this.session.options.mode,r=this.session.me.pub,i=this.subTo,u=!1,p=s.MEDIA_KINDS,e=0,o=p.length;e<o;e++)n=p[e],h=(null!=r?r[n]:void 0)&&this.sub[n],l=this.pub[n]&&(null!=i?i[n]:void 0),t=null,t=h?l?"sendrecv":"sendonly":l?"recvonly":"inactive",a=this.dirs[n],console.log("Media",this.id,n,t,h,l,"old=",a,this.dirs[n]),t!==a&&(u=!0,this.dirs[n]=t);return u&&c&&this._scheduleRtcReneg(),this.emit("change")},e.prototype._scheduleRtcReneg=function(){return delete this._pendingOfferAnswer,delete this._pendingIceCandidates,this._ensureRtcTimer&&clearTimeout(this._ensureRtcTimer),this._ensureRtcTimer=setTimeout(function(t){return function(){return delete t._ensureRtcTimer,t._ensureRtcReneg()}}(this),100)},e.prototype._ensureRtcReneg=function(){var t,e,n,o,r,i,u,a,c,l,p,h,d;for(a=!1,d={},l={},p=s.MEDIA_KINDS,n=0,i=p.length;n<i;n++)switch(r=p[n],e=this.dirs[r],d[r]=l[r]=!1,"inactive"!==e&&(a=!0),e){case"sendrecv":d[r]=l[r]=!0;break;case"sendonly":d[r]=!0;break;case"recvonly":l[r]=!0}if(c=this.session.me.id<this.id,console.log("ensureRtcReneg",c,d,l,this.dirs),this.rtc)return a?this.rtc.update(d,l):(console.log("Delete Connection with",this.id),this._destroy());if(a&&(!0,console.log("Create Connection with",this.id,this.dirs),c?console.log("Send Offer"):console.log("Wait for Offer"),this.rtc=this._createP2pRtc(c),this.rtc.update(d,l),null!=this._pendingOfferAnswer&&(this.rtc.gotRemoteOfferAnswer(this._pendingOfferAnswer),delete this._pendingOfferAnswer),null!=this._pendingIceCandidates)){for(h=this._pendingIceCandidates,o=0,u=h.length;o<u;o++)t=h[o],this.rtc.gotRemoteIceCandidate(t);return delete this._pendingIceCandidates}},e.prototype._createP2pRtc=function(t){var e;return e=this._createRtc(t),e.on("offerAnswer",function(t){return function(e){return t.signal.send({type:"offerAnswer",data:e})}}(this)),e.on("icecandidate",function(t){return function(e){return t.signal.send({type:"icecandidate",data:e})}}(this)),e.on("video",function(t){return function(e,n){return t.emit("video",e,n)}}(this)),e},e.prototype._createSfuRtc=function(){var t;return t=this._createRtc(!1),t.on("offerAnswer",function(t){return function(e){return t._sendToSfu("start",{data:e,sub:t.subTo})}}(this)),t.on("icecandidate",function(t){return function(e){return t._sendToSfu("trickle",{data:e})}}(this)),t.on("video",function(t){return function(e,n){return t.emit("video",e,n)}}(this)),t},e.prototype._createRtc=function(t){var e,n;return e={getLocalStreams:function(t){return function(e){return t.session.me.capture.getStreams(e)}}(this),getIceServers:this.session.getIceServers},n=new i,n.init(t,e),n},e.prototype._subscribeFromSfu=function(t){var e;return null!=(e=this.rtc)&&e.stop(),this.rtc=null,this.rtc=this._createSfuRtc(),this.rtc.update({},{}),this.rtc.gotRemoteOfferAnswer(t)},e.prototype._sendToSfu=function(t,e){return e.to=this.signal.id,e.id=this.session.id,this.session.channel.signal.conn.rpc("video.session."+t,e)},e}(o),t.exports=r},function(t,e,n){var o,r,i,s,u,a=function(t,e){function n(){this.constructor=t}for(var o in e)c.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},c={}.hasOwnProperty;o=n(0),r=n(31),u=n(33),i=n(7),s=function(t){function e(){e.__super__.constructor.apply(this,arguments),this.connections={},this.sessions={}}return a(e,t),e.prototype.destroy=function(){return this.connections={},this.sessions={}},e.prototype.createSession=function(t,e){return this._connect(t.connection,function(n){return function(o,i){var s;return o?"function"==typeof e?e(o):void 0:(s=new r(t.id,t,i),n.sessions[s.call_id]=s,s.on("end",function(){return n._destroySession(s)}),n.emit("session",s,1),e(null,s))}}(this))},e.prototype._destroySession=function(t){var e,n;if((t=null!=(e=null!=t?t.call_id:void 0)?e:t)&&(n=this.sessions[t]))return delete this.sessions[t],n._destroy(),this.emit("session",n,-1)},e.prototype._connect=function(t,e){var n,o,r;return r=t.url,(n=this.connections[r])?e(null,n):(o=i.generateGUID(),n=new u(o,t),this.connections[r]=n,n.addHandler("verto",this._handleRpcNotify.bind(this),this._handleRpcRequest.bind(this)),n.connect(),e(null,n))},e.prototype._handleRpcNotify=function(t,e){return console.log("Handle VertoRpcNotify",t,e)},e.prototype._handleRpcRequest=function(t,e,n){var o,r,i,s;switch(console.log("Handle VertoRpcRequest",t,e),o=e.callID,s=this.sessions[o],t){case"info":case"display":case"invite":break;case"media":s&&e.sdp&&null!=(r=s.rtc)&&r.gotRemoteOfferAnswer({type:"answer",sdp:e.sdp});break;case"answer":s&&e.sdp&&null!=(i=s.rtc)&&i.gotRemoteOfferAnswer({type:"answer",sdp:e.sdp});break;case"bye":this._destroySession(s);break;default:console.log("Unknown VertoRpc request",t,e)}return n(null,{method:"verto."+t})},e}(o),t.exports=s},function(t,e,n){var o,r,i,s,u,a=function(t,e){function n(){this.constructor=t}for(var o in e)c.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},c={}.hasOwnProperty;o=n(0),n(1),r=n(32),i=n(2),s=n(7),u=function(t){function e(t,n,o){this.id=t,this.options=n,this.conn=o,e.__super__.constructor.apply(this,arguments),this.rtc=null,"sip"===this.options.mode?this.call_id=s.extractUuidFromSessionId(this.id):this.call_id=s.generateGUID(),this.dialogParams={callID:this.call_id},this.bufferedIceCandidates=[],this.bufferedIceCandidatesDone=!1,this.bufferedOfferAnswer=null,this.iceTimer=null}var n;return a(e,t),n=1e3,e.prototype._init=function(t,e){var n,o;if(this.getIceServers=e,this.me=new r("john",t),this.me.once("change",function(t){return function(){return console.log("VertoSession.me change",t.me),t._updateRtc()}}(this)),o=this.options.connection.invite){if(console.log("Invite on init",o),!this.conn.connected())return this.conn.once("open",function(t){return function(){var e;if(t._invite(o,{}),null!=(null!=(e=t.me.pub)?e.audio:void 0))return t._updateRtc()}}(this));if(this._invite(o,{}),null!=(null!=(n=this.me.pub)?n.audio:void 0))return this._updateRtc()}},e.prototype._destroy=function(){var t;return console.log("verto.session destroy"),null!=(t=this.rtc)&&t.stop(),this.rtc=null},e.prototype.dial=function(t,e,n){var o;return o={caller_id_name:e,caller_id_number:e},this._invite(t,o,n)},e.prototype._invite=function(t,e,n){var o,r,s,u;console.log("VertoSession.invite",t,e),this.dialogParams.destination_number=t,null==e&&(e={});for(s in e)u=e[s],this.dialogParams[s]=u;return this.me._publish({audio:!0}),o={getLocalStreams:function(t){return function(e){return t.me.capture.getStreams(e)}}(this),getIceServers:this.getIceServers},this.rtc=new i,this.rtc.init(!0,o),this.rtc.on("offerAnswer",function(t){return function(e){return console.log("ready to send offerAnswer",e),t.bufferedOfferAnswer={type:e.type,sdp:e.sdp},t._maybeSendOfferAnswer()}}(this)),this.rtc.on("icecandidate",function(t){return function(e){var n,o;return console.log("ready to send icecandidate",e),e?(o=e.sdpMLineIndex,null==(n=t.bufferedIceCandidates)[o]&&(n[o]=[]),t.bufferedIceCandidates[o].push(e),t.bufferedIceCandidatesDone=!1):(t.bufferedIceCandidatesDone=!0,t._maybeSendOfferAnswer())}}(this)),r={cancel:function(t){return function(){return t.leave()}}(this)},"function"==typeof n?n(null,r):void 0},e.prototype._maybeSendOfferAnswer=function(){var t;if(console.log("maybeSendOfferAnswer",this.bufferedIceCandidatesDone),this.bufferedOfferAnswer){if(!this.bufferedIceCandidatesDone){if(this.iceTimer)return;return void(this.iceTimer=setTimeout(function(t){return function(){return t.bufferedIceCandidatesDone=!0,t._maybeSendOfferAnswer()}}(this),n))}return t=s.mergeSdp(this.bufferedOfferAnswer,this.bufferedIceCandidates),this.bufferedOfferAnswer=null,this.bufferedIceCandidates=[],this.bufferedIceCandidatesDone=!1,this.iceTimer&&(clearTimeout(this.iceTimer),this.iceTimer=null),console.log("Verto OfferAnswer ready!",t),"offer"===t.type?(t.dialogParams=this.dialogParams,this.conn.rpc("verto.invite",t,function(t,e){return console.log("verto.invite cb",t,e)})):void 0}},e.prototype._updateRtc=function(){var t;return null!=(t=this.rtc)?t.update(this.me.pub,{audio:!0}):void 0},e.prototype.leave=function(){var t;return t={dialogParams:this.dialogParams},this.conn.rpc("verto.bye",t,function(t){return function(e,n){return console.log("verto.bye cb",e,n),t.emit("end")}}(this))},e}(o),t.exports=u},function(t,e,n){var o,r,i=function(t,e){function n(){this.constructor=t}for(var o in e)s.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;o=n(0),n(1),r=function(t){function e(t,n){this.id=t,this.capture=n,e.__super__.constructor.apply(this,arguments),this.pub={}}return i(e,t),e.prototype.publish=function(t){},e.prototype._publish=function(t){var e,n,o,r,i,s;for(t=null!=t?t:{},r=["audio"],e=0,o=r.length;e<o;e++)n=r[e],null==t[n]&&(t[n]=null!=(i=null!=(s=this.pub)?s[n]:void 0)&&i);return this.capture.request(t,function(e){return function(o){var r,i,s;for(o&&(console.log("Error getting local media",o),e.emit("error","Unable to get local media")),s=["audio","video","screen"],r=0,i=s.length;r<i;r++)n=s[r],t[n]=e.capture.options[n]&&!1!==t[n];return e.pub=t,e.emit("change")}}(this))},e}(o),t.exports=r},function(t,e,n){var o,r,i=function(t,e){function n(){this.constructor=t}for(var o in e)s.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},s={}.hasOwnProperty;r=n(6),o=function(t){function e(t,n){this.id=t,this.options=n,e.__super__.constructor.call(this,this.options),this.on("open",function(t){return function(){if(0===t.queue.length)return t.rpc("login",{},function(t,e){if(t)return console.log("Verto login err=",t,"result=",e)})}}(this))}return i(e,t),0,e.prototype.rpc=function(t,n,o){return n.login=this.options.login,n.passwd=this.options.password,n.sessid=this.id,e.__super__.rpc.apply(this,arguments)},e.prototype._getKeepaliveInterval=function(){return 0},e}(r),t.exports=o}])});
//# sourceMappingURL=bit6.min.js.map